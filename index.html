<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>鹅鸭杀发言记</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        /* 默认深色主题 */
        body {
            background-color: #1a1a2e;
            color: #e6e6e6;
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            border: 1px solid #2a3c5e;
            transition: all 0.3s ease;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #ff9966, #ff5e62);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .subtitle {
            font-size: 1.2rem;
            color: #a0a7c2;
            margin-bottom: 20px;
        }
        
        .game-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .game-status {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .status-btn {
            padding: 10px 20px;
            background-color: #2a3c5e;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border: 1px solid transparent;
        }
        
        .status-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .meeting-btn {
            background: linear-gradient(135deg, #ff5e62 0%, #ff9966 100%);
        }
        
        .player-count-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background-color: #16213e;
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid #2a3c5e;
            transition: all 0.3s ease;
        }
        
        .player-count-control label {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .player-count-control input {
            width: 60px;
            background-color: #1a2a42;
            border: 1px solid #2a3c5e;
            color: #e6e6e6;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        /* 修改主内容布局，左侧更宽，右侧更窄 */
        .main-content {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .panel {
            background-color: #16213e;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            border: 1px solid #2a3c5e;
            transition: all 0.3s ease;
        }
        
        .panel-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4cc9f0;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 2px solid #2a3c5e;
            padding-bottom: 10px;
            transition: all 0.3s ease;
        }
        
        /* 优化玩家容器布局 */
        .players-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (max-width: 1400px) {
            .players-container {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 1100px) {
            .players-container {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 900px) {
            .players-container {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .player-card {
            background-color: #1a2a42;
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            opacity: 0.7;
            transform: scale(0.95);
        }
        
        .player-card:hover {
            transform: translateY(-5px) scale(0.97);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            opacity: 0.9;
        }
        
        .player-card.active {
            border-color: #4cc9f0;
            box-shadow: 0 0 20px rgba(76, 201, 240, 0.7);
            opacity: 1;
            transform: scale(1.05);
            z-index: 10;
        }
        
        .player-card.dead {
            background-color: #2a1a2e;
        }
        
        /* 优化玩家名称显示 - 单行显示 */
        .player-name-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .player-number {
            font-weight: bold;
            color: #ff9e00;
            font-size: 1.1rem;
            min-width: 30px;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1.1rem;
            color: #e6e6e6;
            flex-grow: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .player-name-input {
            background-color: transparent;
            border: 1px solid #2a3c5e;
            color: #e6e6e6;
            padding: 5px 10px;
            border-radius: 6px;
            width: 100%;
            font-size: 1rem;
            margin-bottom: 10px;
        }
        
        .player-name-input:focus {
            outline: none;
            border-color: #4cc9f0;
        }
        
        .player-role {
            font-size: 0.9rem;
            color: #a0a7c2;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .role-select-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }
        
        .role-select {
            flex-grow: 1;
            background-color: #2a3c5e;
            color: #e6e6e6;
            border: 1px solid #3a4c6e;
            border-radius: 6px;
            padding: 8px 10px;
            font-size: 0.9rem;
            cursor: pointer;
        }
        
        .role-select:focus {
            outline: none;
            border-color: #4cc9f0;
        }
        
        .add-role-btn {
            background-color: #4361ee;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .add-role-btn:hover {
            background-color: #3a56d4;
        }
        
        .player-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            margin-top: auto;
        }
        
        .alive {
            background-color: #2a5c3d;
            color: #7ae582;
        }
        
        .dead {
            background-color: #5c2a2a;
            color: #ff7b7b;
        }
        
        .speech-input-container {
            margin-top: 20px;
            position: relative;
        }
        
        .speech-input {
            width: 100%;
            height: 120px;
            background-color: #1a2a42;
            border: 1px solid #2a3c5e;
            border-radius: 10px;
            padding: 15px;
            color: #e6e6e6;
            font-size: 1rem;
            resize: vertical;
            margin-bottom: 15px;
        }
        
        .speech-input:focus {
            outline: none;
            border-color: #4cc9f0;
            box-shadow: 0 0 10px rgba(76, 201, 240, 0.3);
        }
        
        .autocomplete-suggestions {
            position: absolute;
            background-color: #1a2a42;
            border: 1px solid #2a3c5e;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            width: 100%;
            z-index: 100;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #2a3c5e;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: #2a3c5e;
        }
        
        .suggestion-item:last-child {
            border-bottom: none;
        }
        
        .suggestion-player-name {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .suggestion-hint {
            font-size: 0.8rem;
            color: #a0a7c2;
            margin-left: 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #38b000 0%, #2d9140 100%);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #ff9e00 0%, #ff5e62 100%);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #f72585 0%, #b5179e 100%);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* 卡片内小按钮强制单行 */
        .player-card .btn {
            white-space: nowrap;
        }
        
        .speech-log {
            max-height: 600px;
            min-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .speech-item {
            background-color: #1a2a42;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #4361ee;
        }
        
        .speech-item.suspicious {
            border-left-color: #ff5e62;
            background-color: #2a1a2e;
        }
        
        .speech-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .speaker {
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .meeting-number {
            color: #a0a7c2;
            font-size: 0.9rem;
        }
        
        .speech-content {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .speech-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .tag {
            padding: 4px 10px;
            background-color: #2a3c5e;
            border-radius: 12px;
            font-size: 0.8rem;
        }
        
        .tag.role-claim {
            background-color: #3d348b;
            color: #b5b8ff;
        }
        
        .tag.location {
            background-color: #2a5c3d;
            color: #7ae582;
        }
        
        .tag.suspect {
            background-color: #5c2a2a;
            color: #ff7b7b;
        }
        
        .tag.alibi {
            background-color: #2a4a5c;
            color: #7ad7f0;
        }
        
        /* 受害者标签样式 */
        .tag.victim {
            background-color: #2a4a5c;
            color: #7ad7f0;
        }
        
        .analysis-panel {
            grid-column: 1 / -1;
        }
        
        .contradictions-list {
            margin-top: 20px;
        }
        
        .contradiction-item {
            background-color: #2a1a2e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #f72585;
        }
        
        .contradiction-player {
            font-weight: bold;
            color: #ff7b7b;
            margin-bottom: 8px;
        }
        
        .contradiction-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        .contradiction-statement {
            background-color: #1a2a42;
            padding: 10px;
            border-radius: 8px;
        }
        
        .meeting-indicator {
            font-size: 0.9rem;
            color: #a0a7c2;
            margin-top: 5px;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #16213e 0%, #0f3460 100%);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            border: 1px solid #2a3c5e;
        }
        
        .summary-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            color: #4cc9f0;
        }
        
        .summary-content {
            line-height: 1.6;
        }
        
        .highlight {
            background-color: rgba(255, 158, 0, 0.2);
            padding: 2px 5px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: #16213e;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            border: 1px solid #2a3c5e;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #4cc9f0;
            text-align: center;
        }
        
        .modal-message {
            margin-bottom: 25px;
            line-height: 1.6;
        }
        
        .modal-input {
            width: 100%;
            background-color: #1a2a42;
            border: 1px solid #2a3c5e;
            color: #e6e6e6;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1rem;
        }
        
        .modal-input:focus {
            outline: none;
            border-color: #4cc9f0;
        }
        
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #a0a7c2;
            font-size: 0.9rem;
            border-top: 1px solid #2a3c5e;
        }
        
        /* 明牌身份面板样式 */
        .open-roles-container {
            margin-top: 20px;
            margin-bottom: 20px;
            padding: 20px;
            background-color: #1a2a42;
            border-radius: 10px;
            border: 1px solid #2a3c5e;
        }
        
        .open-roles-title {
            font-size: 1.2rem;
            color: #4cc9f0;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .open-roles-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .open-role-tag {
            padding: 8px 15px;
            background-color: #2a5c3d;
            color: #7ae582;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* 排除身份面板样式 */
        .excluded-roles-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #1a2a42;
            border-radius: 10px;
            border: 1px dashed #2a3c5e;
        }
        
        .excluded-roles-title {
            font-size: 1.1rem;
            color: #a0a7c2;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .excluded-roles-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .excluded-role-tag {
            padding: 6px 12px;
            background-color: #2a3c5e;
            color: #a0a7c2;
            border-radius: 15px;
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .open-role-tag.duck {
            background-color: #5c2a2a;
            color: #ff7b7b;
        }
        
        .open-role-tag.neutral {
            background-color: #2a4a5c;
            color: #7ad7f0;
        }
        
        .open-role-tag .remove-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            display: flex;
            align-items: center;
        }
        
        .role-selection {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        
        .role-option {
            padding: 6px 12px;
            background-color: #2a3c5e;
            color: #a0a7c2;
            border-radius: 6px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .role-option:hover {
            background-color: #3a4c6e;
            color: #e6e6e6;
        }
        
        .role-option.selected {
            background-color: #4361ee;
            color: white;
        }
        
        .clear-names-btn {
            margin-left: 10px;
            background-color: #5c2a2a;
            color: #ff7b7b;
        }
        
        .clear-names-btn:hover {
            background-color: #6c3a3a;
        }

        /* 自定义身份管理样式 */
        .custom-role-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background-color: #1a2a42;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid #2a3c5e;
        }
        
        .custom-role-name {
            font-weight: 500;
        }
        
        .custom-role-actions {
            display: flex;
            gap: 8px;
        }
        
        .delete-custom-role-btn {
            background-color: #5c2a2a;
            color: #ff7b7b;
            border: none;
            border-radius: 6px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .delete-custom-role-btn:hover {
            background-color: #6c3a3a;
        }

        /* 在一起关系面板样式 */
        .together-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #1a2a42;
            border-radius: 10px;
            border: 1px solid #2a3c5e;
        }
        
        .together-title {
            font-size: 1.1rem;
            color: #4cc9f0;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .together-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .together-tag {
            padding: 6px 12px;
            background-color: #2a5c3d;
            color: #7ae582;
            border-radius: 15px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .together-tag .remove-btn {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0;
            display: flex;
            align-items: center;
        }

        /* 对局记录面板样式 */
        .match-history-panel {
            margin-top: 30px;
            padding: 20px;
            background-color: #1a2a42;
            border-radius: 15px;
            border: 1px solid #2a3c5e;
        }
        
        .match-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .match-history-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        
        .match-item {
            background-color: #16213e;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #4361ee;
            transition: all 0.3s ease;
        }
        
        .match-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .match-item.win {
            border-left-color: #38b000;
        }
        
        .match-item.loss {
            border-left-color: #ff5e62;
        }
        
        .match-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .match-date {
            color: #a0a7c2;
            font-size: 0.9rem;
        }
        
        .match-result {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .match-result.win {
            background-color: #2a5c3d;
            color: #7ae582;
        }
        
        .match-result.loss {
            background-color: #5c2a2a;
            color: #ff7b7b;
        }
        
        .match-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .my-role {
            background-color: #2a3c5e;
            padding: 8px 12px;
            border-radius: 8px;
            font-weight: bold;
            color: #4cc9f0;
        }
        
        .match-players {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .match-player-tag {
            padding: 4px 10px;
            background-color: #2a3c5e;
            border-radius: 12px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .match-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .delete-match-btn {
            background-color: #5c2a2a;
            color: #ff7b7b;
            border: none;
            border-radius: 6px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        
        .delete-match-btn:hover {
            background-color: #6c3a3a;
        }
        
        .win-rate-display {
            margin-top: 15px;
            padding: 10px;
            background-color: #16213e;
            border-radius: 8px;
            border: 1px solid #2a3c5e;
        }
        
        .win-rate-bar {
            height: 10px;
            background-color: #2a3c5e;
            border-radius: 5px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .win-rate-fill {
            height: 100%;
            background: linear-gradient(90deg, #38b000, #2d9140);
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            .game-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .match-details {
                grid-template-columns: 1fr;
            }
        }

        /* ========== 白色主题（Apple风格） ========== */
        body.apple {
            background-color: #f5f5f7;
            color: #1c1c1e;
        }
        
        body.apple header {
            background: linear-gradient(135deg, #ffffff 0%, #f2f2f7 100%);
            border: 1px solid #e5e5ea;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
        }
        
        body.apple h1 {
            background: linear-gradient(90deg, #007aff, #5856d6);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: none;
        }
        
        body.apple .subtitle {
            color: #6e6e73;
        }
        
        body.apple .panel {
            background-color: #ffffff;
            border: 1px solid #e5e5ea;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
        }
        
        body.apple .panel-title {
            color: #007aff;
            border-bottom-color: #e5e5ea;
        }
        
        body.apple .player-card {
            background-color: #ffffff;
            border: 1px solid #e5e5ea;
            opacity: 1;
            transform: none;
        }
        
        body.apple .player-card:hover {
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
            transform: translateY(-5px) scale(0.97);
            border-color: #c7c7cc;
        }
        
        body.apple .player-card.active {
            border-color: #007aff;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.2), 0 10px 20px rgba(0, 0, 0, 0.1);
        }
        
        body.apple .player-card.dead {
            background-color: #f9f9f9;
            opacity: 0.7;
        }
        
        body.apple .player-number {
            color: #ff9500;
        }
        
        body.apple .player-name {
            color: #1c1c1e;
        }
        
        body.apple .player-name-input {
            background-color: #f2f2f7;
            border-color: #c7c7cc;
            color: #1c1c1e;
        }
        
        body.apple .player-name-input:focus {
            border-color: #007aff;
        }
        
        body.apple .player-role {
            color: #6e6e73;
        }
        
        body.apple .role-select {
            background-color: #f2f2f7;
            border-color: #c7c7cc;
            color: #1c1c1e;
        }
        
        body.apple .role-select:focus {
            border-color: #007aff;
        }
        
        body.apple .add-role-btn {
            background-color: #007aff;
        }
        
        body.apple .add-role-btn:hover {
            background-color: #0056cc;
        }
        
        body.apple .player-status.alive {
            background-color: #d1f7c4;
            color: #2d8500;
        }
        
        body.apple .player-status.dead {
            background-color: #ffd1d1;
            color: #d70000;
        }
        
        body.apple .status-btn {
            background-color: #007aff;
            color: #fff;
        }
        
        body.apple .meeting-btn {
            background: linear-gradient(135deg, #ff3b30, #ff9500);
        }
        
        body.apple .btn-primary {
            background: linear-gradient(135deg, #007aff, #0056cc);
        }
        
        body.apple .btn-success {
            background: linear-gradient(135deg, #34c759, #2caa4a);
        }
        
        body.apple .btn-warning {
            background: linear-gradient(135deg, #ff9500, #e68500);
        }
        
        body.apple .btn-danger {
            background: linear-gradient(135deg, #ff3b30, #d70000);
        }
        
        body.apple .speech-item {
            background-color: #ffffff;
            border-left-color: #007aff;
        }
        
        body.apple .speech-item.suspicious {
            background-color: #fff5f5;
            border-left-color: #ff3b30;
        }
        
        body.apple .speaker {
            color: #007aff;
        }
        
        body.apple .tag {
            background-color: #f2f2f7;
            color: #6e6e73;
        }
        
        body.apple .tag.role-claim {
            background-color: #d1e8ff;
            color: #007aff;
        }
        
        body.apple .tag.location {
            background-color: #d1f7c4;
            color: #2d8500;
        }
        
        body.apple .tag.suspect {
            background-color: #ffd1d1;
            color: #ff3b30;
        }
        
        body.apple .tag.alibi {
            background-color: #e5f6ff;
            color: #00a2ff;
        }
        
        body.apple .tag.victim {
            background-color: #e5f6ff;
            color: #00a2ff;
        }
        
        body.apple .open-roles-container {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .open-role-tag {
            background-color: #d1f7c4;
            color: #2d8500;
        }
        
        body.apple .open-role-tag.duck {
            background-color: #ffd1d1;
            color: #ff3b30;
        }
        
        body.apple .open-role-tag.neutral {
            background-color: #e5f6ff;
            color: #00a2ff;
        }
        
        body.apple .summary-box {
            background: linear-gradient(135deg, #ffffff, #f2f2f7);
            border-color: #e5e5ea;
        }
        
        body.apple .summary-title {
            color: #007aff;
        }
        
        body.apple .highlight {
            background-color: rgba(0, 122, 255, 0.1);
        }
        
        body.apple .excluded-roles-container {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .excluded-roles-title {
            color: #6e6e73;
        }
        
        body.apple .excluded-role-tag {
            background-color: #f2f2f7;
            color: #8e8e93;
        }
        
        body.apple .player-count-control {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .player-count-control label {
            color: #007aff;
        }
        
        body.apple .player-count-control input {
            background-color: #f2f2f7;
            border-color: #c7c7cc;
            color: #1c1c1e;
        }
        
        body.apple .clear-names-btn {
            background-color: #ff3b30;
            color: white;
        }
        
        body.apple .clear-names-btn:hover {
            background-color: #d70000;
        }
        
        body.apple .modal-content {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .modal-title {
            color: #007aff;
        }
        
        body.apple .modal-input {
            background-color: #f2f2f7;
            border-color: #c7c7cc;
            color: #1c1c1e;
        }
        
        body.apple .modal-input:focus {
            border-color: #007aff;
        }
        
        body.apple footer {
            color: #6e6e73;
            border-top-color: #e5e5ea;
        }
        
        body.apple .custom-role-item {
            background-color: #f2f2f7;
            border-color: #e5e5ea;
        }
        
        body.apple .delete-custom-role-btn {
            background-color: #ff3b30;
            color: white;
        }
        
        body.apple .delete-custom-role-btn:hover {
            background-color: #d70000;
        }
        
        body.apple .contradiction-item {
            background-color: #fff5f5;
            border-left-color: #ff3b30;
        }
        
        body.apple .contradiction-player {
            color: #ff3b30;
        }
        
        body.apple .contradiction-statement {
            background-color: #ffffff;
        }
        
        body.apple .speech-input {
            background-color: #f2f2f7;
            border-color: #c7c7cc;
            color: #1c1c1e;
        }
        
        body.apple .speech-input:focus {
            border-color: #007aff;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.2);
        }
        
        body.apple .autocomplete-suggestions {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .suggestion-item:hover {
            background-color: #f2f2f7;
        }
        
        body.apple .suggestion-player-name {
            color: #007aff;
        }
        
        body.apple .suggestion-hint {
            color: #8e8e93;
        }
        
        body.apple .together-container {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .together-title {
            color: #007aff;
        }
        
        body.apple .together-tag {
            background-color: #d1f7c4;
            color: #2d8500;
        }
        
        body.apple .match-history-panel {
            background-color: #ffffff;
            border-color: #e5e5ea;
        }
        
        body.apple .match-item {
            background-color: #f9f9f9;
            border-left-color: #007aff;
        }
        
        body.apple .match-item.win {
            border-left-color: #34c759;
        }
        
        body.apple .match-item.loss {
            border-left-color: #ff3b30;
        }
        
        body.apple .match-result.win {
            background-color: #d1f7c4;
            color: #2d8500;
        }
        
        body.apple .match-result.loss {
            background-color: #ffd1d1;
            color: #ff3b30;
        }
        
        body.apple .my-role {
            background-color: #e5f6ff;
            color: #007aff;
        }
        
        body.apple .match-player-tag {
            background-color: #f2f2f7;
            color: #1c1c1e;
        }
        
        body.apple .win-rate-display {
            background-color: #f9f9f9;
            border-color: #e5e5ea;
        }
        
        body.apple .win-rate-bar {
            background-color: #e5e5ea;
        }
        
        body.apple .win-rate-fill {
            background: linear-gradient(90deg, #34c759, #2caa4a);
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-feather-alt"></i> 鹅鸭杀发言记录工具</h1>
            <p class="subtitle">记录玩家发言、提取关键信息、检测矛盾点、优化游戏决策</p>
            
            <div class="game-controls">
                <div class="game-status">
                    <button class="status-btn meeting-btn" id="startMeetingBtn">
                        <i class="fas fa-bullhorn"></i> 开始会议
                    </button>
                    <button class="status-btn" id="endMeetingBtn">
                        <i class="fas fa-flag-checkered"></i> 结束会议
                    </button>
                    <button class="status-btn" id="newGameBtn">
                        <i class="fas fa-plus-circle"></i> 新游戏
                    </button>
                    <button class="status-btn clear-names-btn" id="clearNamesBtn">
                        <i class="fas fa-user-times"></i> 清空名称
                    </button>
                    <button class="status-btn" id="toggleThemeBtn">
                        <i class="fas fa-adjust"></i> 切换主题
                    </button>
                    <button class="status-btn" id="manageCustomRolesBtn">
                        <i class="fas fa-user-cog"></i> 管理身份池
                    </button>
                    <button class="status-btn" id="viewMatchHistoryBtn">
                        <i class="fas fa-history"></i> 对局记录
                    </button>
                    <button class="status-btn" id="screenshotOcrBtn">
                        <i class="fas fa-camera"></i> 截图识名
                    </button>
                </div>
                
                <div class="player-count-control">
                    <label for="playerCount">玩家数量:</label>
                    <input type="number" id="playerCount" min="4" max="16" value="10">
                    <button class="btn btn-primary" id="updatePlayerCountBtn">
                        <i class="fas fa-sync-alt"></i> 更新
                    </button>
                </div>
            </div>
            
            <div id="meetingStatus">
                当前状态：游戏进行中 - <span id="currentMeeting">第 1 次会议</span>
                <span id="myRoleDisplay" style="margin-left: 20px; color: #4cc9f0; display: none;">
                    <i class="fas fa-user"></i> 我的身份: <span id="myCurrentRole">未知</span>
                </span>
            </div>
        </header>
        
        <!-- 明牌身份面板 -->
        <div class="open-roles-container">
            <div class="open-roles-title">
                <span><i class="fas fa-eye"></i> 本局明牌身份</span>
                <button class="btn btn-primary" id="manageOpenRolesBtn">
                    <i class="fas fa-cog"></i> 管理明牌身份
                </button>
                <button class="btn btn-warning" id="manageExcludedRolesBtn" style="margin-left:8px;">
                    <i class="fas fa-ban"></i> 管理排除身份
                </button>
                <button class="btn btn-success" id="setMyRoleBtn" style="margin-left:8px;">
                    <i class="fas fa-user-edit"></i> 设置我的身份
                </button>
            </div>
            <div class="open-roles-list" id="openRolesList">
                <div style="color: #a0a7c2; text-align: center; width: 100%; padding: 10px;">
                    暂无明牌身份，点击"管理明牌身份"按钮设置
                </div>
            </div>
            
            <!-- 排除身份面板 -->
            <div class="excluded-roles-container">
                <div class="excluded-roles-title">
                    <i class="fas fa-ban"></i> 本局排除身份（房主设置）
                </div>
                <div class="excluded-roles-list" id="excludedRolesList">
                    <div style="color: #a0a7c2; text-align: center; width: 100%; padding: 5px;">
                        暂无排除身份，点击"管理排除身份"设置
                    </div>
                </div>
            </div>
            
            <!-- 在一起关系面板 -->
            <div class="together-container">
                <div class="together-title">
                    <i class="fas fa-users"></i> 玩家在一起状态（本轮会议前）
                    <button class="btn btn-primary" id="manageTogetherBtn" style="margin-left:auto; font-size:0.8rem; padding:5px 10px;">
                        <i class="fas fa-plus"></i> 标记在一起
                    </button>
                </div>
                <div class="together-list" id="togetherList">
                    <div style="color: #a0a7c2; text-align: center; width: 100%; padding: 5px;">
                        暂无记录，点击"标记在一起"按钮添加
                    </div>
                </div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-users"></i> 玩家列表</h2>
                <div class="players-container" id="playersContainer">
                    <!-- 玩家卡片将通过JS动态生成 -->
                </div>
                
                <div class="speech-input-container">
                    <h3 class="panel-title"><i class="fas fa-microphone"></i> 记录发言</h3>
                    <div id="selectedPlayerInfo">当前未选择玩家 (点击玩家卡片下方的"选择发言"按钮)</div>
                    
                    <textarea class="speech-input" id="speechInput" placeholder="在此输入玩家的发言内容..."></textarea>
                    <div class="autocomplete-suggestions" id="autocompleteSuggestions"></div>
                    
                    <div class="button-group">
                        <button class="btn btn-primary" id="recordSpeechBtn">
                            <i class="fas fa-save"></i> 记录发言
                        </button>
                        <button class="btn btn-warning" id="analyzeSpeechBtn">
                            <i class="fas fa-search"></i> 智能分析
                        </button>
                        <button class="btn btn-danger" id="markSuspiciousBtn">
                            <i class="fas fa-exclamation-triangle"></i> 标记可疑
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-history"></i> 发言记录</h2>
                <div class="speech-log" id="speechLog">
                    <!-- 发言记录将通过JS动态生成 -->
                </div>
            </div>
            
            <div class="panel analysis-panel">
                <h2 class="panel-title"><i class="fas fa-chart-line"></i> 分析与总结</h2>
                <div class="button-group">
                    <button class="btn btn-success" id="generateSummaryBtn">
                        <i class="fas fa-file-alt"></i> 生成会议总结
                    </button>
                    <button class="btn btn-warning" id="findContradictionsBtn">
                        <i class="fas fa-balance-scale"></i> 检测矛盾发言
                    </button>
                    <button class="btn btn-primary" id="suggestVoteBtn">
                        <i class="fas fa-vote-yea"></i> 投票建议
                    </button>
                    <button class="btn btn-danger" id="endGameBtn">
                        <i class="fas fa-flag-checkered"></i> 结束本局
                    </button>
                </div>
                
                <div class="summary-box" id="summaryBox">
                    <h3 class="summary-title">会议总结</h3>
                    <div class="summary-content" id="summaryContent">
                        点击"生成会议总结"按钮，系统将分析所有发言并生成总结报告。
                    </div>
                </div>
                
                <div class="contradictions-list" id="contradictionsList">
                    <!-- 矛盾点将通过JS动态生成 -->
                </div>
            </div>
        </div>
        
        <!-- 对局记录面板 -->
        <div class="match-history-panel" id="matchHistoryPanel" style="display: none;">
            <div class="match-history-header">
                <h2 class="panel-title"><i class="fas fa-history"></i> 对局记录</h2>
                <button class="btn btn-primary" id="closeMatchHistoryBtn">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
            
            <div class="win-rate-display">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>今日胜率统计</strong>
                        <div id="winRateText">0胜 0负 (0%)</div>
                    </div>
                    <div style="text-align: right;">
                        <div>总对局: <span id="totalMatches">0</span> 局</div>
                        <div>胜利: <span id="totalWins">0</span> 局</div>
                        <div>失败: <span id="totalLosses">0</span> 局</div>
                    </div>
                </div>
                <div class="win-rate-bar">
                    <div class="win-rate-fill" id="winRateFill" style="width: 0%"></div>
                </div>
            </div>
            
            <div class="match-history-list" id="matchHistoryList">
                <div style="text-align: center; color: #a0a7c2; padding: 40px;">
                    暂无对局记录，点击"结束本局"按钮保存对局记录
                </div>
            </div>
        </div>
        
        <footer>
            <p>鹅鸭杀发言记录分析工具 &copy; 2025</p>
            <p>提示：点击玩家卡片下方的"选择发言"按钮选择发言者，输入发言时自动提示玩家名称</p>
        </footer>
    </div>
    
    <!-- 截图识名模态框 -->
    <div class="modal" id="screenshotOcrModal">
        <div class="modal-content" style="max-width: 900px;">
            <h3 class="modal-title"><i class="fas fa-camera"></i> 截图识名并填充玩家</h3>
            <div class="modal-message">
                <p>上传房间截图后，系统将自动识别中文昵称，并按网格顺序填充到玩家名称位。</p>
            </div>
            <div style="display:flex; gap: 16px; flex-wrap: wrap;">
                <div style="flex: 1 1 520px;">
                    <input type="file" id="ocrImageInput" accept="image/*" class="modal-input" style="margin-bottom: 10px;" />
                    <canvas id="ocrCanvas" style="width:100%; max-height:420px; background:#0f0f1a; border:1px solid #2a3c5e; border-radius:8px;"></canvas>
                    <div style="display:flex; gap:10px; margin-top:10px; align-items:center;">
                        <label>行数</label>
                        <input type="number" id="ocrRows" class="modal-input" value="3" min="1" max="6" style="width:80px;">
                        <label>列数</label>
                        <input type="number" id="ocrCols" class="modal-input" value="3" min="1" max="6" style="width:80px;">
                        <label style="display:flex; align-items:center; gap:6px;">
                            <input type="checkbox" id="ocrAutoCluster" /> 自动聚类
                        </label>
                        <button class="btn btn-primary" id="runOcrBtn">识别</button>
                    </div>
                </div>
                <div style="flex: 1 1 300px;">
                    <h4 style="color:#4cc9f0; margin-bottom:8px;">识别预览</h4>
                    <div id="ocrNamesPreview" style="max-height:420px; overflow:auto; background:#1a2a42; border:1px solid #2a3c5e; border-radius:8px; padding:10px;"></div>
                </div>
            </div>
            <div class="modal-buttons" style="margin-top: 16px;">
                <button class="btn btn-primary" id="applyOcrNamesBtn">应用到玩家</button>
                <button class="btn btn-danger" id="closeScreenshotOcrBtn">关闭</button>
            </div>
        </div>
    </div>
    <!-- 添加自定义职业模态框 -->
    <div class="modal" id="addRoleModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fas fa-user-plus"></i> 添加自定义职业</h3>
            <div class="modal-message">
                <p>请输入新的职业名称：</p>
            </div>
            <input type="text" class="modal-input" id="newRoleInput" placeholder="例如：时空旅人、变形者等">
            <div class="modal-buttons">
                <button class="btn btn-primary" id="saveNewRoleBtn">保存</button>
                <button class="btn btn-danger" id="cancelNewRoleBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 管理明牌身份模态框 -->
    <div class="modal" id="openRolesModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-title"><i class="fas fa-eye"></i> 管理本局明牌身份</h3>
            <div class="modal-message">
                <p>选择本局游戏中出现的明牌身份（轮抽身份池）。勾选的职业会显示在顶部明牌身份面板中。</p>
                <p>提示：鹅阵营通常为绿色，鸭子阵营为红色，中立阵营为蓝色</p>
            </div>
            
            <div class="role-selection" id="openRoleSelection">
                <!-- 角色选项将通过JS动态生成 -->
            </div>
            <div style="display:flex; gap:10px; align-items:center; margin-top: 12px;">
                <input type="text" id="newOpenRoleInput" class="modal-input" placeholder="输入新身份，如：医师、工程师等" style="margin:0; flex:1;">
                <button class="btn btn-primary" id="addOpenRoleBtn" style="flex: none;">添加身份</button>
            </div>
            
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" id="saveOpenRolesBtn">保存选择</button>
                <button class="btn btn-danger" id="cancelOpenRolesBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 管理排除身份模态框 -->
    <div class="modal" id="excludedRolesModal">
        <div class="modal-content" style="max-width: 700px;">
            <h3 class="modal-title"><i class="fas fa-ban"></i> 管理本局排除身份</h3>
            <div class="modal-message">
                <p>选择本局禁止被选择的身份（房主设置）。被排除的身份不会出现在玩家身份下拉中。</p>
            </div>
            <div class="role-selection" id="excludedRoleSelection"></div>
            <div style="display:flex; gap:10px; align-items:center; margin-top: 12px;">
                <input type="text" id="newExcludedRoleInput" class="modal-input" placeholder="输入新身份，如：工程师" style="margin:0; flex:1;">
                <button class="btn btn-primary" id="addExcludedRoleBtn" style="flex: none;">添加身份</button>
            </div>
            <div class="modal-buttons" style="margin-top: 20px;">
                <button class="btn btn-primary" id="saveExcludedRolesBtn">保存选择</button>
                <button class="btn btn-danger" id="cancelExcludedRolesBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 管理自定义身份池模态框 -->
    <div class="modal" id="customRolesModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title"><i class="fas fa-user-cog"></i> 管理自定义身份池</h3>
            <div class="modal-message">
                <p>这里是所有自定义身份的管理界面。删除的身份将不再出现在玩家身份选择器和明牌身份选项中。</p>
            </div>
            
            <div id="customRolesList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                <!-- 自定义身份列表将通过JS动态生成 -->
                <div style="text-align: center; color: #a0a7c2; padding: 20px;">
                    暂无自定义身份
                </div>
            </div>
            
            <div style="display:flex; gap:10px; align-items:center; margin-bottom: 20px;">
                <input type="text" id="newCustomRoleInput" class="modal-input" placeholder="输入新身份名称" style="margin:0; flex:1;">
                <button class="btn btn-primary" id="addCustomRoleBtn" style="flex: none;">添加</button>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-danger" id="closeCustomRolesBtn">关闭</button>
            </div>
        </div>
    </div>
    
    <!-- 标记在一起关系模态框 -->
    <div class="modal" id="togetherModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title"><i class="fas fa-users"></i> 标记玩家在一起</h3>
            <div class="modal-message">
                <p>选择两个玩家标记为"在一起"（本轮会议前）。</p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <label for="togetherPlayer1">玩家 1：</label>
                <select id="togetherPlayer1" class="modal-input" style="margin-bottom: 10px;">
                    <option value="">请选择玩家</option>
                </select>
                
                <label for="togetherPlayer2">玩家 2：</label>
                <select id="togetherPlayer2" class="modal-input">
                    <option value="">请选择玩家</option>
                </select>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-primary" id="saveTogetherBtn">标记在一起</button>
                <button class="btn btn-danger" id="cancelTogetherBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 设置我的身份模态框 -->
    <div class="modal" id="myRoleModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title"><i class="fas fa-user-edit"></i> 设置我的身份</h3>
            <div class="modal-message">
                <p>选择您在本局游戏中的身份：</p>
            </div>
            
            <select id="myRoleSelect" class="modal-input" style="margin-bottom: 20px;">
                <option value="">请选择您的身份</option>
            </select>
            
            <div class="modal-buttons">
                <button class="btn btn-primary" id="saveMyRoleBtn">保存</button>
                <button class="btn btn-danger" id="cancelMyRoleBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- 结束本局游戏模态框 -->
    <div class="modal" id="endGameModal">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title"><i class="fas fa-flag-checkered"></i> 结束本局游戏</h3>
            <div class="modal-message">
                <p>请选择本局游戏结果：</p>
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="btn btn-success" id="recordWinBtn" style="flex: 1;">
                        <i class="fas fa-trophy"></i> 我方胜利
                    </button>
                    <button class="btn btn-danger" id="recordLossBtn" style="flex: 1;">
                        <i class="fas fa-times"></i> 我方失败
                    </button>
                </div>
                <p>提示：结束本局后将保存对局记录，包含所有玩家身份和发言记录。</p>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-danger" id="cancelEndGameBtn">取消</button>
            </div>
        </div>
    </div>
    
    <!-- OCR 库 -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
    <script>
        // ========== 全局变量 ==========
        const gameState = {
            currentMeeting: 1,
            isMeetingActive: false,
            players: [],
            speeches: [],
            selectedPlayerId: null,
            contradictions: [],
            customRoles: [], // 自定义身份池
            openRoles: [],    // 明牌身份
            excludedRoles: [], // 本局排除身份（房主设置）
            togetherGroups: [],      // 记录玩家在一起的组合
            meetingStartTogether: [], // 本轮会议开始时的在一起状态
            myRole: null, // 我的身份
            matchHistory: [] // 对局记录
        };
        
        const baseRoleOptions = [
            "未知","鹅","鸭子","加拿大鹅","正义使者","殡仪员","警长","复仇者","星界行者",
            "模仿者","刺客","专业杀手","静语者","食鸟鸭","政治家","锁匠","冒险家","侦探",
            "通灵","观鸟者","恋人","派对狂","忍者","隐身者","渡鸦","传教士","变形者","呆呆鸟",
            "探测员","狙击手","鸽子","科学家","肉汁","连环杀手","肉汁","爆炸王","超能力者","说客",
            "默剧演员","猎鹰","默剧演员","士兵","生存主义者","掠夺者","跟踪者","小丑"
        ];
        
        const roleCategories = {
            goose: ["鹅","加拿大鹅","正义使者","殡仪员","警长","复仇者","星界行者","模仿者",
                    "冒险家","侦探","通灵","观鸟者","恋人","政治家","锁匠","科学家","肉汁","跟踪者","探测员"],
            duck: ["鸭子","刺客","专业杀手","静语者","食鸟鸭","忍者","隐身者","派对狂","传教士",
                    "变形者","狙击手","默剧演员","小丑","掠夺者","连环杀手"],
            neutral: ["恋人","呆呆鸟","渡鸦","鸽子","鹈鹕","猎鹰"]
        };
        
        function getAllRoleOptions() {
            // 合并基础身份和自定义身份
            return [...baseRoleOptions, ...gameState.customRoles];
        }
        
        let playerNamesBeingEdited = new Set();
        let autocompleteTimeout = null;
        
        // ========== 辅助函数 ==========
        function getRandomColor() {
            const colors = ["#4cc9f0","#4361ee","#3a0ca3","#f72585","#7209b7","#ff9e00","#38b000","#ff5e62","#06d6a0","#118ab2","#9b5de5","#00bbf9","#00f5d4","#fee440","#ff6d6d","#6a0572"];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        function convertToPinyin(chinese) {
            const pinyinMap = {
                '包':'bao','玩':'wan','家':'jia','小':'xiao','明':'ming','红':'hong','蓝':'lan','绿':'lv','黄':'huang','白':'bai','黑':'hei','紫':'zi','橙':'cheng','灰':'hui','金':'jin','银':'yin','铜':'tong','铁':'tie','钢':'gang','木':'mu','水':'shui','火':'huo','土':'tu','风':'feng','雷':'lei','电':'dian','冰':'bing','雪':'xue','雨':'yu','云':'yun','日':'ri','月':'yue','星':'xing','辰':'chen','天':'tian','地':'di','人':'ren','王':'wang','李':'li','张':'zhang','刘':'liu','陈':'chen','杨':'yang','赵':'zhao','黄':'huang','周':'zhou','吴':'wu','徐':'xu','孙':'sun','胡':'hu','朱':'zhu','高':'gao','林':'lin','何':'he','郭':'guo','马':'ma','罗':'luo','梁':'liang','宋':'song','郑':'zheng','谢':'xie','韩':'han','唐':'tang','冯':'feng','于':'yu','董':'dong','萧':'xiao','程':'cheng','曹':'cao','袁':'yuan','邓':'deng','许':'xu','傅':'fu','沈':'shen','曾':'zeng','彭':'peng','吕':'lv','苏':'su','卢':'lu','蒋':'jiang','蔡':'cai','贾':'jia','丁':'ding','魏':'wei','薛':'xue','叶':'ye','阎':'yan','余':'yu','潘':'pan','杜':'du','戴':'dai','夏':'xia','钟':'zhong','汪':'wang','田':'tian','任':'ren','姜':'jiang','范':'fan','方':'fang','石':'shi','姚':'yao','谭':'tan','廖':'liao','邹':'zou','熊':'xiong','金':'jin','陆':'lu','郝':'hao','孔':'kong','白':'bai','崔':'cui','康':'kang','毛':'mao','邱':'qiu','秦':'qin','江':'jiang','史':'shi','顾':'gu','侯':'hou','邵':'shao','孟':'meng','龙':'long','万':'wan','段':'duan','雷':'lei','钱':'qian','汤':'tang','尹':'yin','黎':'li','易':'yi','常':'chang','武':'wu','乔':'qiao','贺':'he','赖':'lai','龚':'gong','文':'wen'
            };
            let pinyin = '';
            for (let i = 0; i < chinese.length; i++) {
                const char = chinese[i];
                pinyin += pinyinMap[char] || char;
            }
            return pinyin;
        }
        
        function getFirstLetters(chinese) {
            const initialMap = {
                '包':'b','玩':'w','家':'j','小':'x','明':'m','红':'h','蓝':'l','绿':'l','黄':'h','白':'b','黑':'h','紫':'z','橙':'c','灰':'h','金':'j','银':'y','铜':'t','铁':'t','钢':'g','木':'m','水':'s','火':'h','土':'t','风':'f','雷':'l','电':'d','冰':'b','雪':'x','雨':'y','云':'y','日':'r','月':'y','星':'x','辰':'c','天':'t','地':'d','人':'r'
            };
            let initials = '';
            for (let i = 0; i < chinese.length; i++) {
                const char = chinese[i];
                initials += initialMap[char] || char.charAt(0);
            }
            return initials;
        }
        
        /**
         * 获取当前输入 token（基于最近的分隔符）
         */
        function getCurrentToken(text, cursorPos) {
            const seps = /[\s，。；、,.;:!?]/;
            let start = cursorPos;
            for (let i = cursorPos - 1; i >= 0; i--) {
                if (seps.test(text[i])) {
                    start = i + 1;
                    break;
                }
                start = i;
            }
            const end = cursorPos;
            const token = text.substring(start, end);
            return { token, start, end };
        }
        
        /**
         * 识别文本中的杀人事件 - 修复版本
         * 修复：正确识别"玩家10刀玩家8"中的凶手(玩家10)和受害者(玩家8)
         */
        function extractKillEvents(text, names) {
            const verbs = ['刀','杀','击杀','干掉','捅','拍'];
            const events = [];
            
            // 按名称长度降序排序，避免部分匹配（如"玩家1"匹配到"玩家10"）
            const sortedNames = [...names].sort((a, b) => b.length - a.length);
            
            // 构建正则表达式模式
            const verbPattern = `(${verbs.join('|')})`;
            
            // 检查所有可能的凶手-受害者组合
            for (const killerName of sortedNames) {
                for (const victimName of sortedNames) {
                    if (killerName === victimName) continue;
                    
                    // 构建正则表达式，确保名称是独立的词
                    const killerPattern = `(${killerName})`;
                    const victimPattern = `(${victimName})`;
                    
                    // 匹配模式：凶手 + 任意字符 + 动词 + 任意字符 + 受害者
                    const pattern = new RegExp(`${killerPattern}[^\\s，。；、,.;:!?]*${verbPattern}[^\\s，。；、,.;:!?]*${victimPattern}`, 'i');
                    
                    if (pattern.test(text)) {
                        // 验证匹配到的内容确实包含这些名称
                        const match = pattern.exec(text);
                        if (match && match[1] === killerName && match[3] === victimName) {
                            events.push({ killerName, victimName });
                            // 找到匹配后跳出内层循环，避免重复
                            break;
                        }
                    }
                }
            }
            
            return events;
        }
        
        // ========== 玩家名称管理（编号+自定义名称）==========
        /**
         * 获取玩家显示名称（编号+名称）
         */
        function getPlayerDisplayName(player) {
            return `${player.number}号玩家 - ${player.customName}`;
        }
        
        /**
         * 获取玩家短名称（仅编号）
         */
        function getPlayerShortName(player) {
            return `${player.number}号`;
        }
        
        /**
         * 从显示名称解析编号和自定义名称
         */
        function parseDisplayName(displayName) {
            const match = displayName.match(/^(\d+)号玩家 - (.+)$/);
            if (match) {
                return {
                    number: parseInt(match[1]),
                    customName: match[2]
                };
            }
            return null;
        }
        
        // ========== 在一起关系管理函数 ==========
        /**
         * 记录玩家在一起的组合
         */
        function recordTogetherGroup(player1Id, player2Id) {
            // 确保组合的唯一性（按ID排序）
            const id1 = Math.min(player1Id, player2Id);
            const id2 = Math.max(player1Id, player2Id);
            
            const existing = gameState.togetherGroups.find(g => 
                (g.player1Id === id1 && g.player2Id === id2) || 
                (g.player1Id === id2 && g.player2Id === id1)
            );
            
            if (!existing) {
                gameState.togetherGroups.push({
                    player1Id: id1,
                    player2Id: id2,
                    meeting: gameState.currentMeeting
                });
                saveGameData();
                renderTogetherList();
                showNotification("已记录在一起组合", 'success');
            } else {
                showNotification("该组合已存在", 'warning');
            }
        }
        
        /**
         * 删除在一起组合
         */
        function removeTogetherGroup(player1Id, player2Id) {
            const id1 = Math.min(player1Id, player2Id);
            const id2 = Math.max(player1Id, player2Id);
            
            gameState.togetherGroups = gameState.togetherGroups.filter(g => 
                !(g.player1Id === id1 && g.player2Id === id2)
            );
            saveGameData();
            renderTogetherList();
            showNotification("已删除在一起组合", 'info');
        }
        
        /**
         * 在会议开始时记录当前的在一起状态
         */
        function recordMeetingStartTogetherState() {
            gameState.meetingStartTogether = [...gameState.togetherGroups];
        }
        
        /**
         * 检查玩家是否和任何玩家在一起
         */
        function isPlayerTogetherWithAny(playerId) {
            return gameState.meetingStartTogether.some(g => 
                g.player1Id === playerId || g.player2Id === playerId
            );
        }
        
        /**
         * 获取和指定玩家在一起的玩家ID列表
         */
        function getTogetherPlayers(playerId) {
            const togetherPlayers = [];
            gameState.meetingStartTogether.forEach(g => {
                if (g.player1Id === playerId) togetherPlayers.push(g.player2Id);
                if (g.player2Id === playerId) togetherPlayers.push(g.player1Id);
            });
            return togetherPlayers;
        }
        
        /**
         * 获取本轮会议没有和任何玩家在一起的玩家
         */
        function getIsolatedPlayers() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            const isolatedPlayers = [];
            
            alivePlayers.forEach(player => {
                const isTogether = isPlayerTogetherWithAny(player.id);
                if (!isTogether) {
                    isolatedPlayers.push(player);
                }
            });
            
            return isolatedPlayers;
        }
        
        /**
         * 渲染在一起关系列表
         */
        function renderTogetherList() {
            const togetherList = document.getElementById('togetherList');
            togetherList.innerHTML = '';
            
            if (gameState.togetherGroups.length === 0) {
                togetherList.innerHTML = '<div style="color: #a0a7c2; text-align: center; width: 100%; padding: 5px;">暂无记录，点击"标记在一起"按钮添加</div>';
            } else {
                gameState.togetherGroups.forEach(group => {
                    const player1 = gameState.players.find(p => p.id === group.player1Id);
                    const player2 = gameState.players.find(p => p.id === group.player2Id);
                    
                    if (player1 && player2) {
                        const togetherTag = document.createElement('div');
                        togetherTag.className = 'together-tag';
                        togetherTag.innerHTML = `
                            <span>${player1.customName}(${player1.number}号) 和 ${player2.customName}(${player2.number}号)</span>
                            <button class="remove-btn" onclick="removeTogetherGroup(${player1.id}, ${player2.id})" title="删除">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        togetherList.appendChild(togetherTag);
                    }
                });
            }
        }
        
        /**
         * 显示标记在一起模态框
         */
        function showTogetherModal() {
            const modal = document.getElementById('togetherModal');
            const player1Select = document.getElementById('togetherPlayer1');
            const player2Select = document.getElementById('togetherPlayer2');
            
            // 清空并重新填充选项
            player1Select.innerHTML = '<option value="">请选择玩家</option>';
            player2Select.innerHTML = '<option value="">请选择玩家</option>';
            
            gameState.players.forEach(player => {
                if (player.status === 'alive') {
                    const option1 = document.createElement('option');
                    option1.value = player.id;
                    option1.textContent = getPlayerDisplayName(player);
                    player1Select.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = player.id;
                    option2.textContent = getPlayerDisplayName(player);
                    player2Select.appendChild(option2);
                }
            });
            
            modal.style.display = 'flex';
        }
        
        /**
         * 保存在一起关系
         */
        function saveTogetherGroup() {
            const player1Select = document.getElementById('togetherPlayer1');
            const player2Select = document.getElementById('togetherPlayer2');
            
            const player1Id = parseInt(player1Select.value);
            const player2Id = parseInt(player2Select.value);
            
            if (!player1Id || !player2Id) {
                showNotification("请选择两个玩家", 'warning');
                return;
            }
            
            if (player1Id === player2Id) {
                showNotification("不能选择同一个玩家", 'warning');
                return;
            }
            
            recordTogetherGroup(player1Id, player2Id);
            document.getElementById('togetherModal').style.display = 'none';
        }
        
        // ========== 核心功能函数 ==========
        function loadGameData() {
            const savedData = localStorage.getItem('gooseGooseDuckTool');
            if (savedData) {
                const data = JSON.parse(savedData);
                Object.assign(gameState, data);
                
                // 兼容旧数据：如果玩家没有number和customName，使用旧逻辑
                gameState.players.forEach((player, index) => {
                    if (!player.number || !player.customName) {
                        if (player.name && player.name.includes('号玩家 - ')) {
                            const parsed = parseDisplayName(player.name);
                            if (parsed) {
                                player.number = parsed.number;
                                player.customName = parsed.customName;
                            } else {
                                player.number = index + 1;
                                player.customName = player.name || `玩家${player.number}`;
                            }
                        } else {
                            player.number = index + 1;
                            player.customName = player.name || `玩家${player.number}`;
                        }
                    }
                });
                
                // 更新我的身份显示
                updateMyRoleDisplay();
                
                // 加载对局记录
                loadMatchHistory();
            } else {
                updatePlayerCount();
            }
        }
        
        function saveGameData() {
            localStorage.setItem('gooseGooseDuckTool', JSON.stringify(gameState));
        }
        
        function clearPlayerNames() {
            if (confirm("确定要清空所有玩家的自定义名称吗？这会将所有玩家名称重置为默认名称。")) {
                gameState.players.forEach((player) => {
                    player.customName = `玩家${player.number}`;
                    player.isEditingName = false;
                });
                playerNamesBeingEdited.clear();
                renderPlayers();
                saveGameData();
                showNotification("已清空所有玩家名称", 'success');
            }
        }
        
        function updatePlayerCount() {
            const playerCountInput = document.getElementById('playerCount');
            let playerCount = parseInt(playerCountInput.value);
            if (isNaN(playerCount) || playerCount < 4) playerCount = 4;
            if (playerCount > 16) playerCount = 16;
            playerCountInput.value = playerCount;
            
            if (gameState.players.length === 0) {
                gameState.players = [];
                for (let i = 1; i <= playerCount; i++) {
                    gameState.players.push({
                        id: i,
                        number: i,
                        customName: `玩家${i}`,
                        role: "未知",
                        status: "alive",
                        color: getRandomColor(),
                        isEditingName: false
                    });
                }
            } else if (playerCount > gameState.players.length) {
                const currentMaxId = Math.max(...gameState.players.map(p => p.id));
                const currentMaxNumber = Math.max(...gameState.players.map(p => p.number));
                for (let i = gameState.players.length + 1; i <= playerCount; i++) {
                    gameState.players.push({
                        id: currentMaxId + (i - gameState.players.length),
                        number: currentMaxNumber + (i - gameState.players.length),
                        customName: `玩家${currentMaxNumber + (i - gameState.players.length)}`,
                        role: "未知",
                        status: "alive",
                        color: getRandomColor(),
                        isEditingName: false
                    });
                }
            } else if (playerCount < gameState.players.length) {
                gameState.players = gameState.players.slice(0, playerCount);
            }
            
            // 重新分配编号与ID（确保连续且一致）
            gameState.players.forEach((player, index) => {
                player.number = index + 1;
                player.id = index + 1;
            });
            
            // 重排后维护选中状态
            if (gameState.selectedPlayerId) {
                const selIndex = Math.max(0, Math.min(gameState.players.length - 1, gameState.selectedPlayerId - 1));
                gameState.selectedPlayerId = selIndex + 1;
            }
            renderPlayers();
            saveGameData();
            showNotification(`玩家数量已更新为 ${playerCount} 人`, 'success');
        }
        
        function renderPlayers() {
            const playersContainer = document.getElementById('playersContainer');
            playersContainer.innerHTML = '';
            const allRoleOptions = getAllRoleOptions();
            const filteredRoleOptions = allRoleOptions.filter(r => !gameState.excludedRoles.includes(r));
            
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.status === 'dead' ? 'dead' : ''} ${gameState.selectedPlayerId === player.id ? 'active' : ''}`;
                playerCard.dataset.id = player.id;
                
                const nameDisplay = player.isEditingName ?
                    `<div class="player-name-container">
                        <div class="player-number">${player.number}号</div>
                        <input type="text" class="player-name-input" value="${player.customName}" data-player-id="${player.id}" onblur="updatePlayerName(${player.id}, this.value)" onkeydown="handleNameInputKeydown(${player.id}, event)" placeholder="输入玩家名称">
                    </div>` :
                    `<div class="player-name-container" onclick="event.stopPropagation(); startEditingPlayerName(${player.id})">
                        <div class="player-number">${player.number}号</div>
                        <div class="player-name">${player.customName}</div>
                    </div>`;
                
                playerCard.innerHTML = `
                    ${nameDisplay}
                    <div class="player-role">身份: ${player.role} ${gameState.openRoles.includes(player.role) ? '<i class="fas fa-eye" style="color:#ff9e00; margin-left:5px;" title="明牌身份"></i>' : ''}</div>
                    <div class="role-select-container">
                        <select class="role-select" onchange="changePlayerRole(${player.id}, this.value)" onclick="event.stopPropagation();">
                            ${filteredRoleOptions.map(role => `<option value="${role}" ${player.role === role ? 'selected' : ''}>${role}</option>`).join('')}
                            <option value="custom">自定义职业...</option>
                        </select>
                        <button class="add-role-btn" title="添加自定义职业" onclick="event.stopPropagation(); showAddRoleModal(${player.id})"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="player-status ${player.status}">${player.status === 'alive' ? '存活' : '已淘汰'}</div>
                    <div style="display: flex; gap: 5px; margin-top: 10px; flex-wrap: nowrap;">
                        <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; flex-grow: 1;" onclick="event.stopPropagation(); togglePlayerStatus(${player.id})">${player.status === 'alive' ? '淘汰' : '复活'}</button>
                        <button class="btn" style="padding: 5px 10px; font-size: 0.8rem; flex-grow: 1; background-color: #7aa2ff; color: #ffffff;" onclick="event.stopPropagation(); selectPlayerForSpeech(${player.id})">选择发言</button>
                    </div>`;
                playersContainer.appendChild(playerCard);
            });
            updateSelectedPlayerInfo();
        }
        
        function showAddRoleModal(playerId) {
            const modal = document.getElementById('addRoleModal');
            modal.dataset.playerId = playerId || '';
            document.getElementById('newRoleInput').value = '';
            modal.style.display = 'flex';
        }
        
        function saveCustomRole() {
            const modal = document.getElementById('addRoleModal');
            const newRole = document.getElementById('newRoleInput').value.trim();
            if (!newRole) {
                showNotification("请输入职业名称！", 'warning');
                return;
            }
            
            const allRoleOptions = getAllRoleOptions();
            if (allRoleOptions.includes(newRole)) {
                showNotification("该职业已存在！", 'warning');
                return;
            }
            
            gameState.customRoles.push(newRole);
            const playerId = modal.dataset.playerId;
            if (playerId) {
                const player = gameState.players.find(p => p.id == playerId);
                if (player) {
                    player.role = newRole;
                }
            }
            
            modal.style.display = 'none';
            renderPlayers();
            saveGameData();
            showNotification(`已添加自定义职业: ${newRole}`, 'success');
        }
        
        function cancelCustomRole() {
            const modal = document.getElementById('addRoleModal');
            modal.style.display = 'none';
        }
        
        function startEditingPlayerName(playerId) {
            gameState.players.forEach(player => {
                player.isEditingName = false;
            });
            const player = gameState.players.find(p => p.id === playerId);
            if (player) {
                player.isEditingName = true;
                playerNamesBeingEdited.add(playerId);
                renderPlayers();
                setTimeout(() => {
                    const input = document.querySelector(`input[data-player-id="${playerId}"]`);
                    if (input) {
                        input.focus();
                        input.select();
                    }
                }, 10);
            }
        }
        
        function updatePlayerName(playerId, newName) {
            const player = gameState.players.find(p => p.id === playerId);
            if (player) {
                player.customName = newName.trim() || `玩家${player.number}`;
                player.isEditingName = false;
                playerNamesBeingEdited.delete(playerId);
                renderPlayers();
                saveGameData();
            }
        }
        
        function handleNameInputKeydown(playerId, event) {
            if (event.key === 'Enter') {
                updatePlayerName(playerId, event.target.value);
            } else if (event.key === 'Escape') {
                const player = gameState.players.find(p => p.id === playerId);
                if (player) {
                    player.isEditingName = false;
                    playerNamesBeingEdited.delete(playerId);
                    renderPlayers();
                }
            }
        }
        
        function selectPlayerForSpeech(playerId) {
            gameState.selectedPlayerId = playerId;
            renderPlayers();
            document.getElementById('speechInput').focus();
        }
        
        function updateSelectedPlayerInfo() {
            const selectedPlayerInfo = document.getElementById('selectedPlayerInfo');
            if (gameState.selectedPlayerId) {
                const player = gameState.players.find(p => p.id === gameState.selectedPlayerId);
                selectedPlayerInfo.innerHTML = `当前发言者: <span style="color: ${player.color}; font-weight: bold;">${getPlayerDisplayName(player)}</span> (${player.role}) - ${player.status === 'alive' ? '存活' : '已淘汰'}`;
            } else {
                selectedPlayerInfo.innerHTML = "当前未选择玩家 (点击玩家卡片下方的'选择发言'按钮)";
            }
        }
        
        function changePlayerRole(playerId, newRole) {
            if (newRole === 'custom') {
                showAddRoleModal(playerId);
                const player = gameState.players.find(p => p.id === playerId);
                setTimeout(() => {
                    const select = document.querySelector(`.player-card[data-id="${playerId}"] .role-select`);
                    if (select && player) {
                        select.value = player.role;
                    }
                }, 10);
                return;
            }
            const player = gameState.players.find(p => p.id === playerId);
            if (gameState.excludedRoles && gameState.excludedRoles.includes(newRole)) {
                player.role = '未知';
                showNotification('该身份已被房主排除，已重置为未知', 'warning');
            } else {
                player.role = newRole;
            }
            saveGameData();
            renderPlayers();
        }
        
        function togglePlayerStatus(playerId) {
            const player = gameState.players.find(p => p.id === playerId);
            player.status = player.status === 'alive' ? 'dead' : 'alive';
            renderPlayers();
            saveGameData();
        }
        
        // ========== 我的身份管理 ==========
        function updateMyRoleDisplay() {
            const myRoleDisplay = document.getElementById('myRoleDisplay');
            const myCurrentRole = document.getElementById('myCurrentRole');
            
            if (gameState.myRole) {
                myRoleDisplay.style.display = 'inline';
                myCurrentRole.textContent = gameState.myRole;
            } else {
                myRoleDisplay.style.display = 'none';
            }
        }
        
        function showMyRoleModal() {
            const modal = document.getElementById('myRoleModal');
            const roleSelect = document.getElementById('myRoleSelect');
            
            roleSelect.innerHTML = '<option value="">请选择您的身份</option>';
            
            const allRoles = getAllRoleOptions();
            allRoles.forEach(role => {
                if (role !== "未知") {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    if (role === gameState.myRole) {
                        option.selected = true;
                    }
                    roleSelect.appendChild(option);
                }
            });
            
            modal.style.display = 'flex';
        }
        
        function saveMyRole() {
            const roleSelect = document.getElementById('myRoleSelect');
            const selectedRole = roleSelect.value;
            
            if (selectedRole) {
                gameState.myRole = selectedRole;
                updateMyRoleDisplay();
                saveGameData();
                showNotification(`已设置您的身份为: ${selectedRole}`, 'success');
            } else {
                gameState.myRole = null;
                updateMyRoleDisplay();
                saveGameData();
                showNotification(`已清除您的身份设置`, 'info');
            }
            
            document.getElementById('myRoleModal').style.display = 'none';
        }
        
        // ========== 明牌身份和排除身份管理 ==========
        function renderOpenRoles() {
            const openRolesList = document.getElementById('openRolesList');
            openRolesList.innerHTML = '';
            
            if (gameState.openRoles.length === 0) {
                openRolesList.innerHTML = '<div style="color: #a0a7c2; text-align: center; width: 100%; padding: 10px;">暂无明牌身份，点击"管理明牌身份"按钮设置</div>';
            } else {
                gameState.openRoles.forEach(role => {
                    let category = 'neutral';
                    if (roleCategories.goose.includes(role)) {
                        category = 'goose';
                    } else if (roleCategories.duck.includes(role)) {
                        category = 'duck';
                    }
                    
                    const roleTag = document.createElement('div');
                    roleTag.className = `open-role-tag ${category}`;
                    roleTag.innerHTML = `<span>${role}</span><button class="remove-btn" onclick="removeOpenRole('${role}')"><i class="fas fa-times"></i></button>`;
                    openRolesList.appendChild(roleTag);
                });
            }
            
            // 渲染排除身份
            renderExcludedRoles();
        }
        
        /**
         * 渲染排除身份面板
         * @function renderExcludedRoles
         */
        function renderExcludedRoles() {
            const excludedRolesList = document.getElementById('excludedRolesList');
            excludedRolesList.innerHTML = '';
            if (!gameState.excludedRoles || gameState.excludedRoles.length === 0) {
                excludedRolesList.innerHTML = '<div style="color: #a0a7c2; text-align: center; width: 100%; padding: 5px;">暂无排除身份，点击"管理排除身份"设置</div>';
                return;
            }
            gameState.excludedRoles.forEach(role => {
                const roleTag = document.createElement('div');
                roleTag.className = 'open-role-tag neutral';
                roleTag.innerHTML = `<span>${role}</span><button class="remove-btn" onclick="removeExcludedRole('${role}')"><i class="fas fa-times"></i></button>`;
                excludedRolesList.appendChild(roleTag);
            });
        }

        /**
         * 打开截图识名弹窗
         */
        function openScreenshotOcrModal(){
            const modal = document.getElementById('screenshotOcrModal');
            const preview = document.getElementById('ocrNamesPreview');
            preview.innerHTML = '<div style="color:#a0a7c2;">请上传截图并点击识别</div>';
            modal.style.display = 'flex';
        }

        /**
         * 在canvas上绘制图片并返回其尺寸
         */
        function drawImageToCanvas(file){
            return new Promise((resolve,reject)=>{
                const canvas = document.getElementById('ocrCanvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                img.onload = ()=>{
                    const maxW = 1200;
                    const scale = Math.min(1, maxW / img.width);
                    canvas.width = Math.floor(img.width * scale);
                    canvas.height = Math.floor(img.height * scale);
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    resolve({width:canvas.width, height:canvas.height});
                };
                img.onerror = reject;
                const reader = new FileReader();
                reader.onload = e=>{ img.src = e.target.result; };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        /**
         * 执行 OCR 识别，返回 words（含bbox与text）
         */
        async function runOcrOnCanvas(){
            const canvas = document.getElementById('ocrCanvas');
            const { data } = await Tesseract.recognize(canvas, 'chi_sim', { logger: ()=>{} });
            return data.words || [];
        }

        /**
         * 根据 rows/cols 生成网格并将文字映射到格子
         */
        function mapWordsToGrid(words, rows, cols, canvasSize){
            const cells = Array.from({length: rows}, ()=> Array.from({length: cols}, ()=>[]));
            const cellW = canvasSize.width / cols;
            const cellH = canvasSize.height / rows;
            words.forEach(w=>{
                const x = (w.bbox.x0 + w.bbox.x1) / 2;
                const y = (w.bbox.y0 + w.bbox.y1) / 2;
                const c = Math.min(cols-1, Math.max(0, Math.floor(x / cellW)));
                const r = Math.min(rows-1, Math.max(0, Math.floor(y / cellH)));
                cells[r][c].push(w);
            });
            return cells;
        }

        /**
         * 仅保留中文，按x排序合并为姓名
         */
        function extractNamesFromCells(cells){
            const names = [];
            for (let r=0; r<cells.length; r++){
                for (let c=0; c<cells[r].length; c++){
                    const ws = cells[r][c].slice().sort((a,b)=> a.bbox.x0 - b.bbox.x0);
                    let text = ws.map(w=> (w.text||'').replace(/[^\u4e00-\u9fa5]/g,'')).join('');
                    text = text.trim();
                    names.push(text || '');
                }
            }
            return names;
        }

        /**
         * 在右侧预览面板渲染识别结果，可编辑
         */
        function renderOcrPreview(names){
            const preview = document.getElementById('ocrNamesPreview');
            preview.innerHTML='';
            names.forEach((name, idx)=>{
                const item = document.createElement('div');
                item.style.cssText = 'display:flex; gap:8px; align-items:center; margin-bottom:8px;';
                item.innerHTML = `<span style="width:48px; color:#a0a7c2;">#${idx+1}</span><input type="text" class="modal-input" value="${name}" data-idx="${idx}" style="flex:1;">`;
                preview.appendChild(item);
            });
        }

        /**
         * 应用识别到的姓名到玩家卡片
         */
        function applyOcrNames(){
            const inputs = document.querySelectorAll('#ocrNamesPreview input');
            const names = Array.from(inputs).map(i=> (i.value||'').trim()).filter(n=> n.length>0);
            const count = Math.min(16, names.length);
            // 扩充玩家数量
            while (gameState.players.length < count){
                gameState.players.push({ id: gameState.players.length+1, number: gameState.players.length+1, customName:`玩家${gameState.players.length+1}`, role:'未知', status:'alive', color:getRandomColor(), isEditingName:false });
            }
            for (let i=0; i<count; i++){
                gameState.players[i].customName = names[i];
            }
            // 统一重排 id/number
            gameState.players.forEach((p, idx)=>{ p.id = idx+1; p.number = idx+1; });
            saveGameData();
            renderPlayers();
            showNotification(`已应用 ${count} 个姓名`, 'success');
            document.getElementById('screenshotOcrModal').style.display = 'none';
        }

        /**
         * 显示排除身份管理弹窗
         * @function showExcludedRolesModal
         */
        function showExcludedRolesModal() {
            const modal = document.getElementById('excludedRolesModal');
            const selection = document.getElementById('excludedRoleSelection');
            selection.innerHTML = '';
            const roles = getAllRoleOptions().filter(r => r !== '未知');
            roles.forEach(role => {
                const isExcluded = gameState.excludedRoles.includes(role);
                const div = document.createElement('div');
                div.className = `role-option ${isExcluded ? 'selected' : ''}`;
                div.dataset.role = role;
                div.innerHTML = role;
                div.addEventListener('click', () => div.classList.toggle('selected'));
                selection.appendChild(div);
            });
            modal.style.display = 'flex';
        }

        /**
         * 保存排除身份选择
         * @function saveExcludedRoles
         */
        function saveExcludedRoles() {
            const modal = document.getElementById('excludedRolesModal');
            const selected = Array.from(document.querySelectorAll('#excludedRoleSelection .role-option.selected')).map(el => el.dataset.role);
            gameState.excludedRoles = selected;
            // 若玩家当前身份被排除，重置为未知
            gameState.players.forEach(p => {
                if (gameState.excludedRoles.includes(p.role)) {
                    p.role = '未知';
                }
            });
            saveGameData();
            renderExcludedRoles();
            renderPlayers();
            modal.style.display = 'none';
            showNotification(`已排除 ${selected.length} 个身份`, 'success');
        }

        /**
         * 关闭排除身份弹窗
         * @function cancelExcludedRoles
         */
        function cancelExcludedRoles(){ const modal = document.getElementById('excludedRolesModal'); modal.style.display = 'none'; }

        /**
         * 从排除面板移除单个身份
         * @function removeExcludedRole
         */
        function removeExcludedRole(role){ gameState.excludedRoles = gameState.excludedRoles.filter(r => r !== role); saveGameData(); renderExcludedRoles(); renderPlayers(); }

        /**
         * 在排除弹窗中添加自定义身份并默认选中
         * @function addExcludedRoleFromModal
         */
        function addExcludedRoleFromModal(){ const input = document.getElementById('newExcludedRoleInput'); if (!input) return; const roleName = (input.value||'').trim(); if (!roleName){ showNotification('请输入新身份名称', 'warning'); return; } const allRoles = getAllRoleOptions(); if (allRoles.includes(roleName)){ showNotification('该身份已存在', 'warning'); return; } if (roleName.length > 20){ showNotification('身份名称过长', 'warning'); return; } gameState.customRoles.push(roleName); if (!gameState.excludedRoles.includes(roleName)){ gameState.excludedRoles.push(roleName); } saveGameData(); input.value=''; showExcludedRolesModal(); showNotification(`已添加并排除身份：${roleName}`, 'success'); }
        
        function showOpenRolesModal() {
            const modal = document.getElementById('openRolesModal');
            const selectionContainer = document.getElementById('openRoleSelection');
            selectionContainer.innerHTML = '';
            
            const allRoles = getAllRoleOptions();
            const rolesToShow = allRoles.filter(role => role !== "未知");
            
            rolesToShow.forEach(role => {
                const isSelected = gameState.openRoles.includes(role);
                let category = 'neutral';
                if (roleCategories.goose.includes(role)) {
                    category = 'goose';
                } else if (roleCategories.duck.includes(role)) {
                    category = 'duck';
                }
                
                const roleOption = document.createElement('div');
                roleOption.className = `role-option ${isSelected ? 'selected' : ''}`;
                roleOption.dataset.role = role;
                roleOption.dataset.category = category;
                roleOption.innerHTML = role;
                roleOption.addEventListener('click', () => {
                    roleOption.classList.toggle('selected');
                });
                selectionContainer.appendChild(roleOption);
            });
            modal.style.display = 'flex';
        }
        
        function addOpenRoleFromModal() {
            const input = document.getElementById('newOpenRoleInput');
            if (!input) return;
            
            const roleName = (input.value || '').trim();
            if (!roleName) {
                showNotification('请输入新身份名称', 'warning');
                return;
            }
            
            // 检查是否已存在
            const allRoles = getAllRoleOptions();
            if (allRoles.includes(roleName)) {
                showNotification('该身份已存在', 'warning');
                return;
            }
            
            if (roleName.length > 20) {
                showNotification('身份名称过长', 'warning');
                return;
            }
            
            // 添加到自定义身份池
            if (!gameState.customRoles.includes(roleName)) {
                gameState.customRoles.push(roleName);
            }
            
            // 同时添加到明牌身份
            if (!gameState.openRoles.includes(roleName)) {
                gameState.openRoles.push(roleName);
            }
            
            saveGameData();
            input.value = '';
            
            // 重新打开模态框以更新列表
            showOpenRolesModal();
            showNotification(`已添加并选中身份：${roleName}`, 'success');
        }
        
        function saveOpenRoles() {
            const modal = document.getElementById('openRolesModal');
            const selectedOptions = document.querySelectorAll('#openRoleSelection .role-option.selected');
            const selectedRoles = Array.from(selectedOptions).map(option => option.dataset.role);
            
            gameState.openRoles = selectedRoles;
            modal.style.display = 'none';
            renderOpenRoles();
            renderPlayers();
            saveGameData();
            showNotification(`已设置 ${selectedRoles.length} 个明牌身份`, 'success');
        }
        
        function cancelOpenRoles() {
            const modal = document.getElementById('openRolesModal');
            modal.style.display = 'none';
        }
        
        function removeOpenRole(role) {
            gameState.openRoles = gameState.openRoles.filter(r => r !== role);
            renderOpenRoles();
            renderPlayers();
            saveGameData();
            showNotification(`已移除明牌身份: ${role}`, 'info');
        }
        
        // ========== 自定义身份池管理 ==========
        function showCustomRolesModal() {
            const modal = document.getElementById('customRolesModal');
            const customRolesList = document.getElementById('customRolesList');
            customRolesList.innerHTML = '';
            
            if (gameState.customRoles.length === 0) {
                customRolesList.innerHTML = '<div style="text-align: center; color: #a0a7c2; padding: 20px;">暂无自定义身份</div>';
            } else {
                gameState.customRoles.forEach((role, index) => {
                    const roleItem = document.createElement('div');
                    roleItem.className = 'custom-role-item';
                    roleItem.innerHTML = `
                        <div class="custom-role-name">${role}</div>
                        <div class="custom-role-actions">
                            <button class="delete-custom-role-btn" onclick="deleteCustomRole(${index})">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </div>
                    `;
                    customRolesList.appendChild(roleItem);
                });
            }
            
            modal.style.display = 'flex';
        }
        
        function deleteCustomRole(index) {
            const roleToDelete = gameState.customRoles[index];
            
            // 从自定义身份池中移除
            gameState.customRoles.splice(index, 1);
            
            // 同时从明牌身份中移除（如果存在）
            gameState.openRoles = gameState.openRoles.filter(r => r !== roleToDelete);
            
            // 更新所有玩家的角色（如果使用了被删除的身份，则重置为"未知"）
            gameState.players.forEach(player => {
                if (player.role === roleToDelete) {
                    player.role = "未知";
                }
            });
            
            saveGameData();
            renderPlayers();
            renderOpenRoles();
            
            // 重新打开模态框以更新列表
            showCustomRolesModal();
            showNotification(`已删除自定义身份: ${roleToDelete}`, 'success');
        }
        
        function addCustomRoleFromModal() {
            const input = document.getElementById('newCustomRoleInput');
            if (!input) return;
            
            const roleName = (input.value || '').trim();
            if (!roleName) {
                showNotification('请输入身份名称', 'warning');
                return;
            }
            
            // 检查是否已存在（包括基础身份）
            const allRoles = getAllRoleOptions();
            if (allRoles.includes(roleName)) {
                showNotification('该身份已存在', 'warning');
                return;
            }
            
            if (roleName.length > 20) {
                showNotification('身份名称过长', 'warning');
                return;
            }
            
            gameState.customRoles.push(roleName);
            saveGameData();
            input.value = '';
            
            // 重新打开模态框以更新列表
            showCustomRolesModal();
            showNotification(`已添加自定义身份: ${roleName}`, 'success');
        }
        
        // ========== 发言和自动补全 ==========
        function handleSpeechInput() {
            const input = document.getElementById('speechInput');
            const text = input.value;
            const cursorPos = input.selectionStart;
            
            if (autocompleteTimeout) {
                clearTimeout(autocompleteTimeout);
            }
            
            autocompleteTimeout = setTimeout(() => {
                showAutocompleteSuggestions(text, cursorPos);
            }, 100);
        }
        
        function handleSpeechInputKeydown(event) {
            const suggestions = document.getElementById('autocompleteSuggestions');
            const suggestionItems = suggestions.querySelectorAll('.suggestion-item');
            const activeSuggestion = suggestions.querySelector('.suggestion-item.active');
            
            if (event.key === 'ArrowDown' && suggestionItems.length > 0) {
                event.preventDefault();
                let nextIndex = 0;
                if (activeSuggestion) {
                    const currentIndex = Array.from(suggestionItems).indexOf(activeSuggestion);
                    nextIndex = (currentIndex + 1) % suggestionItems.length;
                    activeSuggestion.classList.remove('active');
                }
                suggestionItems[nextIndex].classList.add('active');
                return;
            }
            
            if (event.key === 'ArrowUp' && suggestionItems.length > 0) {
                event.preventDefault();
                let prevIndex = suggestionItems.length - 1;
                if (activeSuggestion) {
                    const currentIndex = Array.from(suggestionItems).indexOf(activeSuggestion);
                    prevIndex = (currentIndex - 1 + suggestionItems.length) % suggestionItems.length;
                    activeSuggestion.classList.remove('active');
                }
                suggestionItems[prevIndex].classList.add('active');
                return;
            }
            
            if (event.key === 'Enter' && activeSuggestion) {
                event.preventDefault();
                selectAutocompleteSuggestion(activeSuggestion);
                return;
            }
            
            if (event.key === 'Escape') {
                suggestions.style.display = 'none';
                return;
            }
        }
        
        function showAutocompleteSuggestions(text, cursorPos) {
            const suggestions = document.getElementById('autocompleteSuggestions');
            if (!text.trim() || !gameState.selectedPlayerId) {
                suggestions.style.display = 'none';
                return;
            }
            
            const { token, start, end } = getCurrentToken(text, cursorPos);
            const searchTerm = token.toLowerCase();
            const matches = [];
            
            gameState.players.forEach(player => {
                if (player.id === gameState.selectedPlayerId) return;
                
                const displayName = getPlayerDisplayName(player);
                const customName = player.customName;
                const playerNumber = player.number;
                const shortName = getPlayerShortName(player);
                
                const nameLower = displayName.toLowerCase();
                const customNameLower = customName.toLowerCase();
                const pinyin = convertToPinyin(customName).toLowerCase();
                const initials = getFirstLetters(customName).toLowerCase();
                
                // 匹配编号（支持纯数字匹配）
                if (searchTerm && !isNaN(searchTerm) && parseInt(searchTerm) === playerNumber) {
                    matches.push({
                        player,
                        matchType: 'number',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
                
                // 匹配短名称（X号）
                if (searchTerm && shortName.toLowerCase().includes(searchTerm)) {
                    matches.push({
                        player,
                        matchType: 'short',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
                
                // 匹配完整显示名称
                if (searchTerm && nameLower.includes(searchTerm)) {
                    matches.push({
                        player,
                        matchType: 'full',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
                
                // 匹配自定义名称
                if (searchTerm && customNameLower.includes(searchTerm)) {
                    matches.push({
                        player,
                        matchType: 'custom',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
                
                // 匹配拼音
                if (searchTerm && pinyin.includes(searchTerm)) {
                    matches.push({
                        player,
                        matchType: 'pinyin',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
                
                // 匹配首字母
                if (searchTerm && initials.includes(searchTerm)) {
                    matches.push({
                        player,
                        matchType: 'initial',
                        replaceStart: start,
                        replaceEnd: end,
                        displayText: displayName
                    });
                }
            });
            
            if (matches.length === 0) {
                suggestions.style.display = 'none';
                return;
            }
            
            // 去重（同一个玩家可能匹配到多个条件）
            const uniqueMatches = [];
            const seenPlayerIds = new Set();
            matches.forEach(match => {
                if (!seenPlayerIds.has(match.player.id)) {
                    seenPlayerIds.add(match.player.id);
                    uniqueMatches.push(match);
                }
            });
            
            suggestions.innerHTML = '';
            
            // 按匹配优先级排序
            uniqueMatches.sort((a, b) => {
                const order = { number: 0, short: 1, full: 2, custom: 3, pinyin: 4, initial: 5 };
                return order[a.matchType] - order[b.matchType];
            });
            
            const displayMatches = uniqueMatches.slice(0, 5);
            displayMatches.forEach((match, index) => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'suggestion-item';
                if (index === 0) suggestionItem.classList.add('active');
                
                const hintMap = {
                    'number': '编号匹配',
                    'short': '短名称匹配',
                    'full': '全名匹配',
                    'custom': '自定义名匹配',
                    'pinyin': '拼音匹配',
                    'initial': '首字母匹配'
                };
                
                const hint = hintMap[match.matchType] || '匹配';
                suggestionItem.innerHTML = `<span class="suggestion-player-name">${match.displayText}</span><span class="suggestion-hint">(${hint})</span>`;
                suggestionItem.dataset.replaceStart = String(match.replaceStart);
                suggestionItem.dataset.replaceEnd = String(match.replaceEnd);
                suggestionItem.dataset.displayText = match.displayText;
                suggestionItem.addEventListener('click', () => selectAutocompleteSuggestion(suggestionItem));
                suggestions.appendChild(suggestionItem);
            });
            suggestions.style.display = 'block';
        }
        
        function selectAutocompleteSuggestion(suggestionItem) {
            const input = document.getElementById('speechInput');
            const text = input.value;
            
            const displayText = suggestionItem.dataset.displayText;
            if (!displayText) return;
            
            const replaceStart = parseInt(suggestionItem.dataset.replaceStart || '0', 10);
            const replaceEnd = parseInt(suggestionItem.dataset.replaceEnd || String(input.selectionStart), 10);
            
            const before = text.substring(0, replaceStart);
            const after = text.substring(replaceEnd);
            input.value = before + displayText + after;
            
            const newPos = replaceStart + displayText.length;
            input.setSelectionRange(newPos, newPos);
            document.getElementById('autocompleteSuggestions').style.display = 'none';
            input.focus();
        }
        
        // ========== 会议管理 ==========
        function startMeeting() {
            // 记录会议开始时的在一起状态
            recordMeetingStartTogetherState();
            
            gameState.isMeetingActive = true;
            gameState.currentMeeting++;
            updateMeetingStatus();
            showNotification(`第 ${gameState.currentMeeting} 次会议开始！请记录玩家发言。`, 'info');
        }
        
        function endMeeting() {
            if (!gameState.isMeetingActive) return;
            gameState.isMeetingActive = false;
            updateMeetingStatus();
            generateSummary();
            showNotification(`第 ${gameState.currentMeeting} 次会议结束！`, 'info');
        }
        
        function updateMeetingStatus() {
            const meetingStatus = document.getElementById('currentMeeting');
            meetingStatus.textContent = `第 ${gameState.currentMeeting} 次会议${gameState.isMeetingActive ? ' (进行中)' : ''}`;
        }
        
        function newGame() {
            if (confirm("确定开始新游戏吗？当前会议记录、玩家状态和在一起关系将被重置，但玩家名称和自定义职业会保留。")) {
                gameState.currentMeeting = 1;
                gameState.isMeetingActive = false;
                gameState.speeches = [];
                gameState.selectedPlayerId = null;
                gameState.contradictions = [];
                gameState.togetherGroups = [];
                gameState.meetingStartTogether = [];
                playerNamesBeingEdited.clear();
                
                gameState.players.forEach(player => {
                    player.status = "alive";
                });
                
                renderPlayers();
                renderSpeeches();
                renderTogetherList();
                updateMeetingStatus();
                clearAnalysis();
                saveGameData();
                showNotification("新游戏已开始！所有玩家状态和在一起关系已重置。", 'success');
            }
        }
        
        // ========== 发言记录和分析 ==========
        function recordSpeech() {
            if (!gameState.selectedPlayerId) {
                showNotification("请先选择玩家！", 'warning');
                return;
            }
            
            const speechText = document.getElementById('speechInput').value.trim();
            if (!speechText) {
                showNotification("请输入发言内容！", 'warning');
                return;
            }
            
            const player = gameState.players.find(p => p.id === gameState.selectedPlayerId);
            const speech = {
                id: Date.now(),
                playerId: player.id,
                playerName: getPlayerDisplayName(player),
                meeting: gameState.currentMeeting,
                content: speechText,
                timestamp: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                tags: [],
                suspicious: false
            };
            
            analyzeSpeechContent(speech);
            gameState.speeches.push(speech);
            renderSpeeches();
            document.getElementById('speechInput').value = '';
            saveGameData();
            showNotification(`已记录${getPlayerDisplayName(player)}的发言`, 'success');
        }
        
        /**
         * 分析发言内容生成标签 - 修复版本
         * 修复：正确识别杀人事件中的凶手和受害者
         */
        function analyzeSpeechContent(speech) {
            const content = speech.content;
            const contentLower = content.toLowerCase();
            const tagSet = new Set();
            
            // 获取所有玩家名称用于匹配
            const playerNames = gameState.players.map(p => ({
                displayName: getPlayerDisplayName(p).toLowerCase(),
                customName: p.customName.toLowerCase(),
                number: p.number,
                shortName: getPlayerShortName(p).toLowerCase()
            }));
            
            // 身份声明
            if (contentLower.includes('我是') || contentLower.includes('我的身份是') || contentLower.includes('我是鹅') || contentLower.includes('我是鸭子')) {
                tagSet.add(JSON.stringify({ type: 'role-claim', text: '身份声明' }));
            }
            
            // 地点信息
            const locations = ['大堂','餐厅','厨房','引擎室','指挥室','医疗室','实验室','保安室','储藏室'];
            locations.forEach(location => {
                if (contentLower.includes(location.toLowerCase())) {
                    tagSet.add(JSON.stringify({ type: 'location', text: `地点:${location}` }));
                }
            });
            
            // 杀人事件识别
            const names = playerNames.map(p => p.customName);
            const events = extractKillEvents(contentLower, names);
            
            events.forEach(ev => {
                const killer = gameState.players.find(p => p.customName.toLowerCase() === ev.killerName);
                const victim = gameState.players.find(p => p.customName.toLowerCase() === ev.victimName);
                
                // 只有凶手会被标记为怀疑对象
                if (killer && getPlayerDisplayName(killer) !== speech.playerName) {
                    tagSet.add(JSON.stringify({ type: 'suspect', text: `怀疑:${getPlayerDisplayName(killer)}` }));
                }
                
                if (victim) {
                    tagSet.add(JSON.stringify({ type: 'victim', text: `受害者:${getPlayerDisplayName(victim)}` }));
                }
            });
            
            // 可疑提及（除了杀人事件外的一般怀疑）
            gameState.players.forEach(player => {
                const playerDisplayName = getPlayerDisplayName(player);
                if (playerDisplayName.toLowerCase() === speech.playerName?.toLowerCase()) return;
                
                // 检查是否有直接怀疑的表述
                const suspectPatterns = [
                    `怀疑${player.customName}`,
                    `怀疑${player.number}号`,
                    `${player.customName}可疑`,
                    `${player.number}号可疑`,
                    `${player.customName}有问题`,
                    `${player.number}号有问题`,
                    `可能是${player.customName}`,
                    `可能是${player.number}号`,
                    `${player.customName}是鸭子`,
                    `${player.number}号是鸭子`,
                    `${player.customName}是杀手`,
                    `${player.number}号是杀手`
                ];
                
                const hasDirectSuspect = suspectPatterns.some(pattern => content.includes(pattern));
                
                if (hasDirectSuspect) {
                    tagSet.add(JSON.stringify({ type: 'suspect', text: `怀疑:${getPlayerDisplayName(player)}` }));
                }
            });
            
            // 不在场证明
            if ((contentLower.includes('和') && contentLower.includes('在一起')) || contentLower.includes('看到我在')) {
                tagSet.add(JSON.stringify({ type: 'alibi', text: '不在场证明' }));
            }
            
            // 投票意向
            if (contentLower.includes('投') && contentLower.includes('票')) {
                tagSet.add(JSON.stringify({ type: 'vote', text: '投票意向' }));
            }
            
            speech.tags = Array.from(tagSet).map(s => JSON.parse(s));
        }
        
        function analyzeSpeech() {
            const speechText = document.getElementById('speechInput').value.trim();
            if (!speechText) {
                showNotification("请先输入发言内容！", 'warning');
                return;
            }
            
            const tmpSpeech = {
                content: speechText,
                playerName: (gameState.players.find(p => p.id === gameState.selectedPlayerId) ? getPlayerDisplayName(gameState.players.find(p => p.id === gameState.selectedPlayerId)) : ''),
                tags: []
            };
            
            analyzeSpeechContent(tmpSpeech);
            
            const keyPoints = [];
            if (tmpSpeech.tags.some(t => t.type === 'role-claim')) keyPoints.push('身份声明');
            if (tmpSpeech.tags.some(t => t.type === 'alibi')) keyPoints.push('不在场证明');
            if (tmpSpeech.tags.some(t => t.type === 'location')) keyPoints.push('地点信息');
            
            const suspects = tmpSpeech.tags.filter(t => t.type === 'suspect').map(t => t.text.replace('怀疑:', ''));
            const victims = tmpSpeech.tags.filter(t => t.type === 'victim').map(t => t.text.replace('受害者:', ''));
            
            let resultHTML = `<h4>分析结果：</h4>`;
            
            if (keyPoints.length > 0) {
                resultHTML += `<p><strong>关键信息：</strong> ${keyPoints.join('、')}</p>`;
            }
            
            if (suspects.length > 0) {
                resultHTML += `<p><strong style="color:#ff5e62">怀疑对象：</strong> ${suspects.join('、')}</p>`;
            }
            
            if (victims.length > 0) {
                resultHTML += `<p><strong>受害者：</strong> ${victims.join('、')}</p>`;
            }
            
            if (keyPoints.length === 0 && suspects.length === 0 && victims.length === 0) {
                resultHTML += `<p><strong style="color:#38b000">无明显可疑因素</strong></p>`;
            }
            
            showNotificationWithDetails("发言分析完成", resultHTML);
        }
        
        function markSuspicious() {
            if (gameState.speeches.length === 0) {
                showNotification("暂无发言记录！", 'warning');
                return;
            }
            
            const latestSpeech = gameState.speeches[gameState.speeches.length - 1];
            latestSpeech.suspicious = !latestSpeech.suspicious;
            renderSpeeches();
            saveGameData();
            showNotification(`${latestSpeech.suspicious ? '已标记' : '已取消'}${latestSpeech.playerName}的发言为可疑`, 'info');
        }
        
        function renderSpeeches() {
            const speechLog = document.getElementById('speechLog');
            speechLog.innerHTML = '';
            
            if (gameState.speeches.length === 0) {
                speechLog.innerHTML = '<p style="text-align: center; color: #a0a7c2; padding: 40px 0;">暂无发言记录</p>';
                return;
            }
            
            const meetings = {};
            gameState.speeches.forEach(speech => {
                if (!meetings[speech.meeting]) {
                    meetings[speech.meeting] = [];
                }
                meetings[speech.meeting].push(speech);
            });
            
            const meetingNumbers = Object.keys(meetings).sort((a, b) => b - a);
            
            meetingNumbers.forEach(meetingNum => {
                const meetingHeader = document.createElement('div');
                meetingHeader.className = 'panel-title';
                meetingHeader.style.marginTop = '20px';
                meetingHeader.style.marginBottom = '10px';
                meetingHeader.innerHTML = `<i class="fas fa-bullhorn"></i> 第 ${meetingNum} 次会议发言`;
                speechLog.appendChild(meetingHeader);
                
                const meetingSpeeches = meetings[meetingNum];
                meetingSpeeches.forEach(speech => {
                    const speechItem = document.createElement('div');
                    speechItem.className = `speech-item ${speech.suspicious ? 'suspicious' : ''}`;
                    
                    let tagsHTML = '';
                    if (speech.tags && speech.tags.length > 0) {
                        tagsHTML = speech.tags.map(tag => `<span class="tag ${tag.type}">${tag.text}</span>`).join('');
                    }
                    
                    speechItem.innerHTML = `
                        <div class="speech-header">
                            <div class="speaker">${speech.playerName}</div>
                            <div class="meeting-number">${speech.timestamp}</div>
                        </div>
                        <div class="speech-content">${speech.content}</div>
                        ${tagsHTML ? `<div class="speech-tags">${tagsHTML}</div>` : ''}
                    `;
                    speechLog.appendChild(speechItem);
                });
            });
            speechLog.scrollTop = 0;
        }
        
        // ========== 分析和总结功能 ==========
        function generateSummary() {
            if (gameState.speeches.length === 0) {
                showNotification("暂无发言记录！", 'warning');
                return;
            }
            
            const currentMeetingSpeeches = gameState.speeches.filter(s => s.meeting === gameState.currentMeeting);
            if (currentMeetingSpeeches.length === 0) {
                document.getElementById('summaryContent').innerHTML = "当前会议暂无发言记录。";
                return;
            }
            
            const roleClaims = [];
            const suspicions = [];
            const alibis = [];
            const mentionedPlayers = {};
            
            currentMeetingSpeeches.forEach(speech => {
                // 身份声明
                if (speech.content.includes('我是') || speech.content.includes('我的身份是')) {
                    roleClaims.push(`${speech.playerName}: "${speech.content.substring(0, 50)}..."`);
                }
                
                // 怀疑关系
                gameState.players.forEach(player => {
                    const displayName = getPlayerDisplayName(player);
                    if (speech.content.includes(player.customName) || speech.content.includes(`${player.number}号`)) {
                        if (speech.content.includes('怀疑') || speech.content.includes('可能是')) {
                            suspicions.push(`${speech.playerName} 怀疑 ${displayName}`);
                            if (!mentionedPlayers[displayName]) {
                                mentionedPlayers[displayName] = { suspicions: 0, mentions: 0 };
                            }
                            mentionedPlayers[displayName].suspicious++;
                        }
                        
                        if (displayName !== speech.playerName) {
                            if (!mentionedPlayers[displayName]) {
                                mentionedPlayers[displayName] = { suspicions: 0, mentions: 0 };
                            }
                            mentionedPlayers[displayName].mentions++;
                        }
                    }
                });
                
                // 不在场证明
                if (speech.content.includes('在一起') || (speech.content.includes('和') && speech.content.includes('在'))) {
                    alibis.push(`${speech.playerName}: "${speech.content.substring(0, 60)}..."`);
                }
            });
            
            let summaryHTML = `<p><strong>第 ${gameState.currentMeeting} 次会议总结：</strong></p>`;
            summaryHTML += `<p>本次会议共有 <span class="highlight">${currentMeetingSpeeches.length}</span> 条发言记录。</p>`;
            
            if (roleClaims.length > 0) {
                summaryHTML += `<p><strong>身份声明：</strong></p><ul>`;
                roleClaims.forEach(claim => {
                    summaryHTML += `<li>${claim}</li>`;
                });
                summaryHTML += `</ul>`;
            }
            
            if (suspicions.length > 0) {
                summaryHTML += `<p><strong>怀疑关系：</strong></p><ul>`;
                suspicions.forEach(suspicion => {
                    summaryHTML += `<li>${suspicion}</li>`;
                });
                summaryHTML += `</ul>`;
            }
            
            if (alibis.length > 0) {
                summaryHTML += `<p><strong>不在场证明：</strong></p><ul>`;
                alibis.forEach(alibi => {
                    summaryHTML += `<li>${alibi}</li>`;
                });
                summaryHTML += `</ul>`;
            }
            
            // 找出最可疑的玩家
            let mostSuspicious = null;
            let maxSuspicions = 0;
            Object.keys(mentionedPlayers).forEach(playerName => {
                if (mentionedPlayers[playerName].suspicious > maxSuspicions) {
                    maxSuspicions = mentionedPlayers[playerName].suspicions;
                    mostSuspicious = playerName;
                }
            });
            
            if (mostSuspicious) {
                summaryHTML += `<p><strong style="color:#ff5e62">重点关注：</strong>玩家 <span class="highlight">${mostSuspicious}</span> 被 ${maxSuspicions} 次怀疑，是当前会议中最可疑的玩家。</p>`;
            }
            
            // 沉默玩家
            const speakingPlayers = [...new Set(currentMeetingSpeeches.map(s => s.playerName))];
            const silentPlayers = gameState.players
                .filter(p => p.status === 'alive' && !speakingPlayers.includes(getPlayerDisplayName(p)))
                .map(p => getPlayerDisplayName(p));
            
            if (silentPlayers.length > 0) {
                summaryHTML += `<p><strong style="color:#ff9e00">沉默玩家：</strong> ${silentPlayers.join('、')} 在本轮会议中没有发言。</p>`;
            }
            
            // 新增：孤立玩家分析（没有和任何玩家在一起的玩家）
            const isolatedPlayers = getIsolatedPlayers();
            if (isolatedPlayers.length > 0) {
                summaryHTML += `<p><strong style="color:#f72585">孤立玩家：</strong>`;
                const isolatedNames = isolatedPlayers.map(p => {
                    const togetherCount = gameState.togetherGroups.filter(g => 
                        g.player1Id === p.id || g.player2Id === p.id
                    ).length;
                    return `${getPlayerDisplayName(p)}${togetherCount > 0 ? ` (有${togetherCount}条在一起记录)` : ''}`;
                }).join('、');
                summaryHTML += `${isolatedNames} 在本轮会议前没有和任何玩家在一起。</p>`;
            } else {
                summaryHTML += `<p><strong style="color:#38b000">孤立玩家：</strong> 所有存活玩家都有在一起的对象。</p>`;
            }
            
            document.getElementById('summaryContent').innerHTML = summaryHTML;
            showNotification("会议总结已生成！", 'success');
        }
        
        function findContradictions() {
            gameState.contradictions = [];
            const playerSpeeches = {};
            
            gameState.speeches.forEach(speech => {
                if (!playerSpeeches[speech.playerName]) {
                    playerSpeeches[speech.playerName] = [];
                }
                playerSpeeches[speech.playerName].push(speech);
            });
            
            Object.keys(playerSpeeches).forEach(playerName => {
                const speeches = playerSpeeches[playerName];
                if (speeches.length < 2) return;
                
                // 身份声明矛盾
                const roleClaims = speeches.filter(s => s.content.includes('我是') || s.content.includes('我的身份是'));
                if (roleClaims.length >= 2) {
                    const claimsText = roleClaims.map(s => s.content);
                    const uniqueClaims = [...new Set(claimsText)];
                    if (uniqueClaims.length > 1) {
                        gameState.contradictions.push({
                            player: playerName,
                            type: '身份声明矛盾',
                            details: `在不同会议中声称了不同的身份`,
                            statements: roleClaims.map(s => ({
                                meeting: s.meeting,
                                content: s.content.substring(0, 80) + (s.content.length > 80 ? '...' : '')
                            }))
                        });
                    }
                }
                
                // 位置信息矛盾
                const locationMentions = speeches.filter(s => s.content.includes('在') && (s.content.includes('看到') || s.content.includes('我在')));
                if (locationMentions.length >= 2) {
                    const meetingsWithLocations = {};
                    locationMentions.forEach(speech => {
                        if (!meetingsWithLocations[speech.meeting]) {
                            meetingsWithLocations[speech.meeting] = [];
                        }
                        meetingsWithLocations[speech.meeting].push(speech);
                    });
                    
                    Object.keys(meetingsWithLocations).forEach(meeting => {
                        const meetingSpeeches = meetingsWithLocations[meeting];
                        if (meetingSpeeches.length >= 2) {
                            const locations = ['大堂','餐厅','厨房','引擎室','指挥室','医疗室','实验室','保安室','储藏室'];
                            const mentionedLocations = [];
                            meetingSpeeches.forEach(speech => {
                                locations.forEach(location => {
                                    if (speech.content.includes(location)) {
                                        mentionedLocations.push(location);
                                    }
                                });
                            });
                            
                            const uniqueLocations = [...new Set(mentionedLocations)];
                            if (uniqueLocations.length > 1) {
                                gameState.contradictions.push({
                                    player: playerName,
                                    type: '位置信息矛盾',
                                    details: `在第${meeting}次会议中提到了多个不同位置`,
                                    statements: meetingSpeeches.map(s => ({
                                        meeting: s.meeting,
                                        content: s.content.substring(0, 80) + (s.content.length > 80 ? '...' : '')
                                    }))
                                });
                            }
                        }
                    });
                }
            });
            
            renderContradictions();
            saveGameData();
            
            if (gameState.contradictions.length > 0) {
                showNotification(`发现 ${gameState.contradictions.length} 处矛盾发言！`, 'warning');
            } else {
                showNotification("未发现明显的矛盾发言。", 'info');
            }
        }
        
        function renderContradictions() {
            const contradictionsList = document.getElementById('contradictionsList');
            if (gameState.contradictions.length === 0) {
                contradictionsList.innerHTML = '<p style="text-align: center; color: #a0a7c2;">未发现矛盾发言</p>';
                return;
            }
            
            contradictionsList.innerHTML = '<h3 class="panel-title"><i class="fas fa-exclamation-circle"></i> 发现的矛盾点</h3>';
            
            gameState.contradictions.forEach((contradiction) => {
                const item = document.createElement('div');
                item.className = 'contradiction-item';
                
                let statementsHTML = '';
                contradiction.statements.forEach(statement => {
                    statementsHTML += `
                        <div class="contradiction-statement">
                            <div>${statement.content}</div>
                            <div class="meeting-indicator">第 ${statement.meeting} 次会议</div>
                        </div>
                    `;
                });
                
                item.innerHTML = `
                    <div class="contradiction-player"><i class="fas fa-user"></i> ${contradiction.player} - ${contradiction.type}</div>
                    <p>${contradiction.details}</p>
                    <div class="contradiction-details">${statementsHTML}</div>
                `;
                contradictionsList.appendChild(item);
            });
        }
        
        function suggestVote() {
            if (gameState.speeches.length === 0) {
                showNotification("暂无发言记录！", 'warning');
                return;
            }
            
            const playerSuspicionCount = {};
            gameState.players.forEach(player => {
                if (player.status === 'alive') {
                    playerSuspicionCount[getPlayerDisplayName(player)] = 0;
                }
            });
            
            gameState.speeches.forEach(speech => {
                gameState.players.forEach(player => {
                    const displayName = getPlayerDisplayName(player);
                    if (speech.content.includes(player.customName) || speech.content.includes(`${player.number}号`)) {
                        if (speech.content.includes('怀疑') || speech.content.includes('投') || speech.content.includes('票')) {
                            if (playerSuspicionCount[displayName] !== undefined) {
                                playerSuspicionCount[displayName]++;
                            }
                        }
                    }
                });
            });
            
            let mostSuspectedPlayer = null;
            let maxSuspicion = 0;
            Object.keys(playerSuspicionCount).forEach(playerName => {
                if (playerSuspicionCount[playerName] > maxSuspicion) {
                    maxSuspicion = playerSuspicionCount[playerName];
                    mostSuspectedPlayer = playerName;
                }
            });
            
            let suggestionHTML = `<h4>投票建议：</h4>`;
            if (mostSuspectedPlayer && maxSuspicion > 0) {
                suggestionHTML += `<p>根据发言记录，玩家 <span class="highlight">${mostSuspectedPlayer}</span> 被提及怀疑 ${maxSuspicion} 次，建议优先投票。</p>`;
                
                const suspicionSpeeches = gameState.speeches
                    .filter(speech => {
                        const player = gameState.players.find(p => getPlayerDisplayName(p) === mostSuspectedPlayer);
                        if (!player) return false;
                        return (speech.content.includes(player.customName) || speech.content.includes(`${player.number}号`)) && 
                               (speech.content.includes('怀疑') || speech.content.includes('投') || speech.content.includes('票'));
                    })
                    .slice(0, 3);
                    
                if (suspicionSpeeches.length > 0) {
                    suggestionHTML += `<p><strong>相关发言：</strong></p><ul>`;
                    suspicionSpeeches.forEach(speech => {
                        suggestionHTML += `<li>${speech.playerName}: "${speech.content.substring(0, 60)}..."</li>`;
                    });
                    suggestionHTML += `</ul>`;
                }
            } else {
                suggestionHTML += `<p>暂无明确的投票目标。建议根据本轮会议的发言和可疑行为决定。</p>`;
            }
            
            // 新增：考虑孤立玩家因素
            const isolatedPlayers = getIsolatedPlayers();
            if (isolatedPlayers.length > 0) {
                suggestionHTML += `<p><strong style="color:#f72585">注意孤立玩家：</strong>`;
                suggestionHTML += `${isolatedPlayers.map(p => getPlayerDisplayName(p)).join('、')} 没有和任何玩家在一起，可能需要特别关注。</p>`;
            }
            
            suggestionHTML += `
                <p><strong>投票策略建议：</strong></p>
                <ul>
                    <li>优先投票给发言自相矛盾的玩家</li>
                    <li>关注没有提供有效信息的沉默玩家</li>
                    <li>注意过度辩解或转移话题的玩家</li>
                    <li>考虑角色技能和游戏进程</li>
                    <li>关注没有和任何玩家在一起的孤立玩家</li>
                </ul>
            `;
            
            showNotificationWithDetails("投票建议生成", suggestionHTML);
        }
        
        function clearAnalysis() {
            document.getElementById('summaryContent').innerHTML = "点击'生成会议总结'按钮，系统将分析所有发言并生成总结报告。";
            document.getElementById('contradictionsList').innerHTML = '';
        }
        
        // ========== 对局记录功能 ==========
        function loadMatchHistory() {
            const savedHistory = localStorage.getItem('gooseGooseDuckMatchHistory');
            if (savedHistory) {
                gameState.matchHistory = JSON.parse(savedHistory);
                updateWinRateDisplay();
            }
        }
        
        function saveMatchHistory() {
            localStorage.setItem('gooseGooseDuckMatchHistory', JSON.stringify(gameState.matchHistory));
        }
        
        function showEndGameModal() {
            const modal = document.getElementById('endGameModal');
            modal.style.display = 'flex';
        }
        
        function recordMatchResult(isWin) {
            // 获取当前日期
            const now = new Date();
            const dateStr = now.toLocaleDateString('zh-CN');
            const timeStr = now.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
            
            // 收集玩家信息
            const playersInfo = gameState.players.map(player => ({
                number: player.number,
                customName: player.customName,
                role: player.role,
                status: player.status
            }));
            
            // 创建对局记录
            const matchRecord = {
                id: Date.now(),
                date: dateStr,
                time: timeStr,
                timestamp: now.getTime(),
                isWin: isWin,
                myRole: gameState.myRole || '未知',
                players: playersInfo,
                speeches: [...gameState.speeches], // 保存发言记录
                meetingCount: gameState.currentMeeting
            };
            
            // 添加到历史记录
            gameState.matchHistory.unshift(matchRecord);
            
            // 限制历史记录数量（最多保存50条）
            if (gameState.matchHistory.length > 50) {
                gameState.matchHistory = gameState.matchHistory.slice(0, 50);
            }
            
            // 保存到本地存储
            saveMatchHistory();
            
            // 更新胜率显示
            updateWinRateDisplay();
            
            // 显示对局记录面板
            showMatchHistory();
            
            // 关闭模态框
            document.getElementById('endGameModal').style.display = 'none';
            
            showNotification(`已记录本局游戏结果：${isWin ? '胜利' : '失败'}`, 'success');
            
            // 开始新游戏
            newGame();
        }
        
        function updateWinRateDisplay() {
            // 获取今日日期
            const today = new Date();
            const todayDateStr = today.toLocaleDateString('zh-CN');
            
            // 筛选今日对局
            const todayMatches = gameState.matchHistory.filter(match => match.date === todayDateStr);
            
            // 计算胜率
            const totalMatches = todayMatches.length;
            const wins = todayMatches.filter(match => match.isWin).length;
            const losses = totalMatches - wins;
            const winRate = totalMatches > 0 ? Math.round((wins / totalMatches) * 100) : 0;
            
            // 更新显示
            document.getElementById('totalMatches').textContent = totalMatches;
            document.getElementById('totalWins').textContent = wins;
            document.getElementById('totalLosses').textContent = losses;
            document.getElementById('winRateText').textContent = `${wins}胜 ${losses}负 (${winRate}%)`;
            document.getElementById('winRateFill').style.width = `${winRate}%`;
        }
        
        function showMatchHistory() {
            // 隐藏主内容，显示对局记录
            document.querySelector('.main-content').style.display = 'none';
            document.getElementById('matchHistoryPanel').style.display = 'block';
            
            // 渲染对局记录列表
            renderMatchHistoryList();
        }
        
        function hideMatchHistory() {
            // 显示主内容，隐藏对局记录
            document.querySelector('.main-content').style.display = 'grid';
            document.getElementById('matchHistoryPanel').style.display = 'none';
        }
        
        function renderMatchHistoryList() {
            const matchHistoryList = document.getElementById('matchHistoryList');
            matchHistoryList.innerHTML = '';
            
            if (gameState.matchHistory.length === 0) {
                matchHistoryList.innerHTML = '<div style="text-align: center; color: #a0a7c2; padding: 40px;">暂无对局记录，点击"结束本局"按钮保存对局记录</div>';
                return;
            }
            
            // 按日期分组
            const matchesByDate = {};
            gameState.matchHistory.forEach(match => {
                if (!matchesByDate[match.date]) {
                    matchesByDate[match.date] = [];
                }
                matchesByDate[match.date].push(match);
            });
            
            // 渲染每个日期的记录
            Object.keys(matchesByDate).forEach(date => {
                const dateHeader = document.createElement('div');
                dateHeader.className = 'panel-title';
                dateHeader.style.marginTop = '20px';
                dateHeader.style.marginBottom = '10px';
                dateHeader.innerHTML = `<i class="fas fa-calendar-day"></i> ${date}`;
                matchHistoryList.appendChild(dateHeader);
                
                matchesByDate[date].forEach(match => {
                    const matchItem = document.createElement('div');
                    matchItem.className = `match-item ${match.isWin ? 'win' : 'loss'}`;
                    
                    // 统计角色信息
                    const roleCounts = {};
                    match.players.forEach(player => {
                        if (player.role !== '未知') {
                            roleCounts[player.role] = (roleCounts[player.role] || 0) + 1;
                        }
                    });
                    
                    const roleInfo = Object.keys(roleCounts).map(role => `${role}×${roleCounts[role]}`).join('、');
                    
                    matchItem.innerHTML = `
                        <div class="match-header">
                            <div class="match-date">${match.time}</div>
                            <div class="match-result ${match.isWin ? 'win' : 'loss'}">${match.isWin ? '胜利' : '失败'}</div>
                        </div>
                        
                        <div class="match-details">
                            <div>
                                <div><strong>我的身份：</strong></div>
                                <div class="my-role">${match.myRole}</div>
                            </div>
                            <div>
                                <div><strong>会议次数：</strong> ${match.meetingCount}</div>
                                <div><strong>发言记录：</strong> ${match.speeches.length} 条</div>
                            </div>
                        </div>
                        
                        <div>
                            <div><strong>玩家身份分布：</strong> ${roleInfo || '无记录'}</div>
                        </div>
                        
                        <div class="match-players">
                            ${match.players.map(player => `
                                <div class="match-player-tag">
                                    <span>${player.number}号${player.customName !== `玩家${player.number}` ? `(${player.customName})` : ''}</span>
                                    <span style="color: ${player.role === '未知' ? '#a0a7c2' : '#4cc9f0'}">${player.role}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="match-actions">
                            <button class="delete-match-btn" onclick="deleteMatchRecord(${match.id})">
                                <i class="fas fa-trash"></i> 删除记录
                            </button>
                        </div>
                    `;
                    
                    matchHistoryList.appendChild(matchItem);
                });
            });
        }
        
        function deleteMatchRecord(matchId) {
            if (confirm("确定要删除这条对局记录吗？")) {
                gameState.matchHistory = gameState.matchHistory.filter(match => match.id !== matchId);
                saveMatchHistory();
                updateWinRateDisplay();
                renderMatchHistoryList();
                showNotification("已删除对局记录", 'info');
            }
        }
        
        // ========== 通知和工具函数 ==========
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background-color: ${type === 'success' ? '#2a5c3d' : type === 'warning' ? '#5c2a2a' : '#2a3c5e'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                max-width: 300px;
                animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            `;
            notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i> ${message}`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        function showNotificationWithDetails(title, details) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.7);
                z-index: 2000;
                display: flex;
                justify-content: center;
                align-items: center;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div style="background-color: #16213e; padding: 25px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 1px solid #2a3c5e;">
                    <h3 style="color: #4cc9f0; margin-bottom: 15px;">${title}</h3>
                    <div>${details}</div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button id="closeDetailsModalBtn" style="padding: 8px 20px; background-color: #4361ee; color: white; border: none; border-radius: 6px; cursor: pointer;">关闭</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            document.getElementById('closeDetailsModalBtn').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }
        
        // ========== 初始化函数 ==========
        function init() {
            loadGameData();
            renderPlayers();
            renderSpeeches();
            renderOpenRoles();
            renderTogetherList();
            updateMeetingStatus();
            
            // 事件监听器
            document.getElementById('startMeetingBtn').addEventListener('click', startMeeting);
            document.getElementById('endMeetingBtn').addEventListener('click', endMeeting);
            document.getElementById('newGameBtn').addEventListener('click', newGame);
            document.getElementById('clearNamesBtn').addEventListener('click', clearPlayerNames);
            document.getElementById('recordSpeechBtn').addEventListener('click', recordSpeech);
            document.getElementById('analyzeSpeechBtn').addEventListener('click', analyzeSpeech);
            document.getElementById('markSuspiciousBtn').addEventListener('click', markSuspicious);
            document.getElementById('generateSummaryBtn').addEventListener('click', generateSummary);
            document.getElementById('findContradictionsBtn').addEventListener('click', findContradictions);
            document.getElementById('suggestVoteBtn').addEventListener('click', suggestVote);
            document.getElementById('updatePlayerCountBtn').addEventListener('click', updatePlayerCount);
            document.getElementById('playerCount').addEventListener('change', function() {
                const value = parseInt(this.value);
                if (value < 4) this.value = 4;
                if (value > 16) this.value = 16;
            });
            
            document.getElementById('saveNewRoleBtn').addEventListener('click', saveCustomRole);
            document.getElementById('cancelNewRoleBtn').addEventListener('click', cancelCustomRole);
            
            document.getElementById('manageOpenRolesBtn').addEventListener('click', showOpenRolesModal);
            document.getElementById('saveOpenRolesBtn').addEventListener('click', saveOpenRoles);
            document.getElementById('cancelOpenRolesBtn').addEventListener('click', cancelOpenRoles);
            document.getElementById('addOpenRoleBtn').addEventListener('click', addOpenRoleFromModal);
            
            // 排除身份事件
            document.getElementById('manageExcludedRolesBtn').addEventListener('click', showExcludedRolesModal);
            document.getElementById('saveExcludedRolesBtn').addEventListener('click', saveExcludedRoles);
            document.getElementById('cancelExcludedRolesBtn').addEventListener('click', cancelExcludedRoles);
            document.getElementById('addExcludedRoleBtn').addEventListener('click', addExcludedRoleFromModal);
            
            document.getElementById('manageCustomRolesBtn').addEventListener('click', showCustomRolesModal);
            document.getElementById('addCustomRoleBtn').addEventListener('click', addCustomRoleFromModal);
            document.getElementById('closeCustomRolesBtn').addEventListener('click', () => {
                document.getElementById('customRolesModal').style.display = 'none';
            });
            
            document.getElementById('toggleThemeBtn').addEventListener('click', () => {
                document.body.classList.toggle('apple');
            });
            
            // 在一起关系事件
            document.getElementById('manageTogetherBtn').addEventListener('click', showTogetherModal);
            document.getElementById('saveTogetherBtn').addEventListener('click', saveTogetherGroup);
            document.getElementById('cancelTogetherBtn').addEventListener('click', () => {
                document.getElementById('togetherModal').style.display = 'none';
            });
            
            // 我的身份事件
            document.getElementById('setMyRoleBtn').addEventListener('click', showMyRoleModal);
            document.getElementById('saveMyRoleBtn').addEventListener('click', saveMyRole);
            document.getElementById('cancelMyRoleBtn').addEventListener('click', () => {
                document.getElementById('myRoleModal').style.display = 'none';
            });
            
            // 对局记录事件
            document.getElementById('endGameBtn').addEventListener('click', showEndGameModal);
            document.getElementById('recordWinBtn').addEventListener('click', () => recordMatchResult(true));
            document.getElementById('recordLossBtn').addEventListener('click', () => recordMatchResult(false));
            document.getElementById('cancelEndGameBtn').addEventListener('click', () => {
                document.getElementById('endGameModal').style.display = 'none';
            });
            
            document.getElementById('viewMatchHistoryBtn').addEventListener('click', showMatchHistory);
            document.getElementById('closeMatchHistoryBtn').addEventListener('click', hideMatchHistory);
            // 截图识名事件
            document.getElementById('screenshotOcrBtn').addEventListener('click', openScreenshotOcrModal);
            document.getElementById('closeScreenshotOcrBtn').addEventListener('click', ()=>{ document.getElementById('screenshotOcrModal').style.display='none'; });
            document.getElementById('applyOcrNamesBtn').addEventListener('click', applyOcrNames);
            document.getElementById('runOcrBtn').addEventListener('click', async ()=>{
                const fileInput = document.getElementById('ocrImageInput');
                const file = fileInput.files && fileInput.files[0];
                if (!file){ showNotification('请先选择截图图片', 'warning'); return; }
                const size = await drawImageToCanvas(file);
                const words = await runOcrOnCanvas();
                const rows = parseInt(document.getElementById('ocrRows').value)||3;
                const cols = parseInt(document.getElementById('ocrCols').value)||3;
                const cells = mapWordsToGrid(words, rows, cols, size);
                const names = extractNamesFromCells(cells);
                renderOcrPreview(names);
            });
            
            const speechInput = document.getElementById('speechInput');
            speechInput.addEventListener('input', handleSpeechInput);
            speechInput.addEventListener('keydown', handleSpeechInputKeydown);
            
            document.addEventListener('click', function(e) {
                const suggestions = document.getElementById('autocompleteSuggestions');
                if (!e.target.closest('.speech-input-container')) {
                    suggestions.style.display = 'none';
                }
            });
            
            // 添加CSS动画
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { transform: translateX(100%); opacity: 0; }
                    to { transform: translateX(0); opacity: 1; }
                }
                @keyframes fadeOut {
                    from { opacity: 1; }
                    to { opacity: 0; }
                }
                @keyframes fadeIn {
                    from { opacity: 0; }
                    to { opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
